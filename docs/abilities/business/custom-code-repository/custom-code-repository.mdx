import Image from '@theme/IdealImage'

# Custom Code Repository

## Requirements

| **ONES** |
| -------- |
| 3.10.28+ |

## Overview

Open platform provides the ability to customize the code repository, which can be used to associate the code commit and pull request of the integrated third-party code repository with the ONES Project issue. After the association is successful, after the team members complete the coding, enter the ID of the issue item involved in the Commit message when submitting the Commit, or enter the ID of the issue item involved in the Title when submitting the Pull Request. Separated by "space", you can view the code commit and code pull request in ONES in real time after submission.

### Ability performance

1. After using this capability, you can click "Link Repository" on the Configuration -> Pipeline settings -> Repository page to view the link code repository options added by the capability

   <Image img={require('./images/code-repo-connector-en.png')} />

2. After associating the code repository through the ability, you can associate the code repository with the built-in types such as GitHub, GitLab, private GitLab, SVN, and Private Bitbucket of the ONES system. After the association is successful, it will be the same as other built-in types in the code repository configuration face list display.

   <Image img={require('./images/code-repo-list-en.png')} />

3. After implementing the new code commit and new code pull request login through the ability, you can view the code association results in the "Code Association" column of the issue item details.

   <Image img={require('./images/code-repo-task-en.png')} />

4. Sprint supports summarizing the code submission data link with requirements, and the sprint leader can follow up the development progress based on this.

   <Image img={require('./images/code-repo-print-en.png')} />

5. Under the sprint overview, the code submissions status of the current iteration will be summarized and counted to help the sprint leader evaluate the development contribution. Currently, it supports the statistics and analysis of the number of code submissions, the trend of the number of code commits, and the number of lines affected by code commits.

   <Image img={require('./images/code-repo-print-overview-en.png')} />

## Usage

### Step 1: Ability configuration to add ability and module to the plugin

#### 1. Add abilities

Use the `OP` command to add capabilities in the plugin project:

```shell
npx op add ability
```

select `custom-code-repository`：

<Image img={require('./images/code-repo-op-add-ability.png')} />

The OP tool will ask whether to use the default value, select Yes, and the OP tool will add the following content to the plugin:

- Add relevant paragraphs in the `abilities` field of `config/plugin.yaml` in the plugin project:

  ```yaml
  service:
    app_id: ...
    name: ability-CustomCodeRepository
    ...
  apis:
    ...
  abilities:
    - id: CkrqExqC
      name: 自定义代码仓库
      version: 1.0.0
      abilityType: CustomCodeRepository
      relateModule:
        addRepoPage: ''
      function:
        removeRepoFunc: removeRepo
      config:
        - key: repoToolName
          label: 关联代码仓工具名称
          value: 自定义代码仓类型
          fieldType: Input
          show: true
        - key: repoToolDesc
          label: 关联代码仓工具描述
          value: 自定义代码仓类型
          fieldType: Input
          show: true
        - key: repoToolIcon
          label: 关联代码仓工具图标
          value: logo.svg
          fieldType: Input
          show: false
  ```

  Among them, the three configurations in abilities.config are mainly used in Configuration -> Pipeline settings -> Repository -> link Code Warehouse page to display the custom code repository link tool configuration, as shown in the following table:

| **Configuration item** | **Description**                                                                                                                                        |
| ---------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| repoToolName           | Custom link code repository tool name (required, max length 128)                                                                                       |
| repoToolDesc           | Custom link code repository tool description (required)                                                                                                |
| repoToolIcon           | Custom link code repository tool name (required, max length 255) <br/>Rule: logo.svg corresponds to the web/public/logo.svg file in the plugin project |

- Add a `custom-code-repository.ts` file in the `backend/src` directory of the plugin project.

  The file includes a default `removeRepo` method implementation, which will be called when the administrator does the "unlink" operation on the repository configuration page. The main purpose of providing this method is to allow the plugin to receive notifications that the code repository is unlink. Developers can keep it unchanged, or modify this method to do custom cleanup logic (note: the return value of the method will not affect the system to remove the link code warehouse).

```typescript
import type { PluginRequest, PluginResponse } from 'open-node/packages/types/dist/types/index'

export async function removeRepo(request: PluginRequest): Promise<PluginResponse> {
  const body = request?.body as any
  if (body && body.data) {
    const repoInfo = body.data
  }
  return {
    body: {
      code: 200,
    },
  }
}
```

#### 2. add modules

Use the `OP` command to add modules in the plugin project:

```shell
npx op add module
```

select [ones:settings:pipeline:default:repo:link](../../slot/module/code_repository/index.md) type module:

<Image img={require('./images/code-repo-op-add-module.png')} />

The OP tool will ask whether to use the default value, select Yes, and the OP tool will add the following content to the plugin:

- Add relevant paragraphs in the `modules` field of `config/plugin.yaml` in the plugin project:

```yaml
modules:
  - id: ones-settings-pipeline-default-repo-link-R5w-
    title: linkRepository
    moduleType: ones:settings:pipeline:default:repo:link
    entry: modules/ones-settings-pipeline-default-repo-link-R5w-/index.html
```

- Add the `ones-settings-pipeline-default-repo-link-R5w-` directory under the `web/src/modules` directory of the plugin project, and there are `index.css` and `index.tsx` in the directory files.

#### 3. Abilities Link Modules

In the `plugin.yaml` file, associate the ability with the module, that is, configure the `id` of the module to the `addRepoPage` value of the ability configuration, and the final effect is as follows:

```yaml
service:
  app_id: ...
  name: ability-CustomCodeRepository
  ...
apis:
  ...
abilities:
  - id: CkrqExqC
    name: CustomCodeRepository
    version: 1.0.0
    abilityType: CustomCodeRepository
    relateModule:
      addRepoPage: 'ones-settings-pipeline-default-repo-link-R5w-'
    function:
      removeRepoFunc: removeRepo
    config:
      - key: repoToolName
        label: 关联代码仓工具名称
        value: 自定义关联代码仓工具
        fieldType: Input
        show: true
      - key: repoToolDesc
        label: 关联代码仓工具描述
        value: 自定义关联代码仓工具
        fieldType: Input
        show: true
      - key: repoToolIcon
        label: 关联代码仓工具图标
        value: logo.svg
        fieldType: Input
        show: false
modules:
  - id: ones-settings-pipeline-default-repo-link-R5w-
    title: linkRepository
    moduleType: ones:settings:pipeline:default:repo:link
    entry: modules/ones-settings-pipeline-default-repo-link-R5w-/index.html
```

### step2: Custom code repository link page

区别于 ONES 系统内置的关联代码仓方式，点击「关联代码仓」下一步有默认的添加关联代码仓的弹窗页面，如下图 Github 方式的关联代码仓页面：

Different from the built-in link code repository type of the ONES system, click "Link Repository" and there will be a default popup window page for adding code repository in the next step, as shown in the following figure for the link code repository page of the Github type:

<Image img={require('./images/code-repo-github-add-repo-en.png')} />

Developers need to customize the logic of the link code repository page in the module `ones-settings-pipeline-default-repo-link-R5w-` to realize the functions of "authentication of code repository platform" and "link code repository". The "authentication of the code repository platform" can be in the form of OAuth or Token or account password, and the developer can decide according to the situation.

:::caution notice
This page is linked with the prompt copy of the success or failure of the code repository, which needs to be implemented by the developer. The successfully linked code repository will be displayed on the code repository management page. At this time, different from the code repository linked with the built-in type, the "View Details" button will be displayed for the plugin associated.
:::

### step3: Add repositories

In order to be able to add the code repositories to the ONES system, we provide the "add code repositories" method in the SDK method, which can be used as follows:

```typescript
import { addRepos } from '@ones-op/node-ability'

const toolUUID: string = 'xxx';
const list: RepoInfo[] = [...];
const batchResponse = await addRepos(toolUUID, list);
```

The input and output parameters of the method are introduced as follows:

**input parameters:**

| Parameter | Type       | Description                                                                           | Require | Value range  |
| --------- | ---------- | ------------------------------------------------------------------------------------- | ------- | ------------ |
| toolUUID  | string     | UUID of the link code repository type                                                 | Y       | len=8        |
| teamUUID  | string     | Team UUID (mandatory for organization-level plugins, optional for team-level plugins) | N       | len=8        |
| list      | RepoInfo[] | Add a list of code repositories                                                       | Y       | 0<=size<=100 |

> RepoInfo

| Parameter         | Type   | Description                                                               | Require | Value range |
| ----------------- | ------ | ------------------------------------------------------------------------- | ------- | ----------- |
| userUUID          | string | add repository user UUID                                                  | Y       | len=8       |
| uri               | string | add repository URI（https://github.com/nodejs/node is https://github.com) | Y       | len<=100    |
| namespace         | string | add repository namespace（https://github.com/nodejs/node is nodejs)       | Y       | len<=256    |
| name              | string | add repository name（https://github.com/nodejs/node is node)              | Y       | len<=256    |
| certificationType | enum   | authentication type (enum: OAUTH、PASSWORD、TOKEN、NONE、OTHER)           | Y       | -           |

**output parameter:**

> BatchRepoResponse

| Parameter    | Type           | Description                                   | Require |
| ------------ | -------------- | --------------------------------------------- | ------- |
| successCount | int            | the number of successfully added repositories | Y       |
| failureCount | int            | the number of failures added repositories     | Y       |
| Responses    | RepoResponse[] | the detail info of add repositories           | Y       |

> RepoResponse

| Parameter | Type    | Description          | Require |
| --------- | ------- | -------------------- | ------- |
| success   | boolean | whether succeed      | Y       |
| uri       | string  | repository uri       | Y       |
| namespace | string  | repository namespace | Y       |
| name      | string  | repository name      | Y       |
| repoUUID  | string  | repository UUID      | Y       |
| error     | string  | error detail         | N       |

The `toolUUID` field corresponds to the UUID unique identifier of the custom code repository type in the ONES system, which can be obtained by defining the following method, where `CkrqExqC` corresponds to the capability ID in the `plugin.yaml` file:

```typescript
import { getAbilityProperties } from '@ones-op/node-ability'

export async function getRepoToolUUID(): Promise<string> {
  const repoToolUUIDKey = 'repoToolUUID'
  const abilityID = 'CkrqExqC'

  let repoToolUUID = ''
  const property = await getAbilityProperties(abilityID, [repoToolUUIDKey])
  if (property?.repoToolUUID) {
    repoToolUUID = property[repoToolUUIDKey]
  }
  return repoToolUUID
}
```

:::caution notice
When calling the `getAbilityProperties` method for a team-level plugin, `teamUUID` can be omitted, and when calling for an organization-level plugin, `teamUUID` must be passed.
:::

### step4: add code repository commit and pull request

After successfully link the code repository, you can call the SDK method to add the commit and pull request data of the code repository to the ONES system.

**1. add commit:**

```typescript
import { addRepos } from '@ones-op/node-ability'

const toolUUID: string = 'xxx';
const repoUUID: string = 'xxx';
const list: AddRepoInfo[] = [...];
await addRepoCommits(toolUUID, repoUUID, list)
```

The input and output parameters of the method are introduced as follows:

**input parameters：**

| Parameter | Type         | Description                                                                           | Require | Value range  |
| --------- | ------------ | ------------------------------------------------------------------------------------- | ------- | ------------ |
| toolUUID  | string       | UUID of the link code repository type                                                 | Y       | len=8        |
| repoUUID  | string       | UUID of the code repository                                                           | Y       | len=8        |
| teamUUID  | string       | Team UUID (mandatory for organization-level plugins, optional for team-level plugins) | N       | len=8        |
| list      | RepoCommit[] | Add a list of code commits                                                            | Y       | 0<=size<=100 |

> RepoCommit

| Parameter      | Type   | Description                                                  | Require | Value range    |
| -------------- | ------ | ------------------------------------------------------------ | ------- | -------------- |
| hash           | string | commit unique identifier                                     | Y       | len<=48        |
| author         | string | commit author                                                | Y       | len<=128       |
| message        | string | commit message                                               | Y       | -              |
| branch         | string | commit branch                                                | Y       | len<=128       |
| url            | string | commit web url                                               | Y       | len<=2048      |
| createAt       | int64  | commit timestamp (unit: second)                              | Y       | min=1          |
| statsTotal     | int64  | Statistics affect the total number of rows                   | N       | max=2147483647 |
| statsAdditions | int64  | Count the total number of rows affected by adding statistics | N       | max=2147483647 |
| statsDeletions | int64  | Count the total number of rows affected by deletion          | N       | max=2147483647 |

**2. add pull request**

```typescript
import { addRepos } from '@ones-op/node-ability'

const toolUUID: string = 'xxx'
const repoUUID: string = 'xxx'
const pullRequest: RepoPullRequest = '{...}'
await addRepoPullRequest(toolUUID, repoUUID, pullRequest)
```

The input and output parameters of the method are introduced as follows:

**input parameters：**

| Parameter | Type            | Description                                                                           | Require | Value range |
| --------- | --------------- | ------------------------------------------------------------------------------------- | ------- | ----------- |
| toolUUID  | string          | UUID of the link code repository type                                                 | Y       | len=8       |
| repoUUID  | string          | UUID of the code repository                                                           | Y       | len=8       |
| teamUUID  | string          | Team UUID (mandatory for organization-level plugins, optional for team-level plugins) | N       | len=8       |
| pr        | RepoPullRequest | pull request info                                                                     | Y       | -           |

> RepoPullRequest

| Parameter  | Type         | Description                                         | Require | Value range    |
| ---------- | ------------ | --------------------------------------------------- | ------- | -------------- |
| number     | number       | pr unique identifier                                | Y       | max=2147483647 |
| action     | enum         | pr action (enum: UPDATE、CLOSE、ADD、REOPEN、MERGE) | Y       | -              |
| author     | string       | pr author                                           | Y       | len<=128       |
| title      | string       | pr title                                            | Y       | len<=256       |
| url        | string       | pr web url                                          | Y       | len<=1024      |
| fromBranch | string       | pr source branch                                    | Y       | len<=128       |
| toBranch   | string       | pr dest branch                                      | Y       | len<=128       |
| createAt   | int64        | pr timestamp (unit: second)                         | Y       | min=1          |
| state      | enum         | pr state (enum: OPEN、MERGED、CLOSED)               | Y       | -              |
| reviewers  | string array | pr reviewers                                        | N       | -              |
| updateAt   | int64        | last update pr timestamp (unit: second)             | N       | min=1          |
| updateUser | string       | last updat pr user name                             | N       | len<=128       |

In order to facilitate the query of linked code repositories information, we provide the following two SDK methods:

**1. query linked single code repository**

```typescript
import { addRepos } from '@ones-op/node-ability'

const toolUUID = 'xxx'
const uri = 'xxx'
const namespace = 'xxx'
const name = 'xxx'
const repoInfo = await queryRepo(toolUUID, uri, namespace, name)
```

The input and output parameters of the method are introduced as follows:

**input parameters：**

| Parameter | Type   | Description                                                                           | Require | Value range |
| --------- | ------ | ------------------------------------------------------------------------------------- | ------- | ----------- |
| toolUUID  | string | UUID of the link code repository type                                                 | Y       | len=8       |
| teamUUID  | string | Team UUID (mandatory for organization-level plugins, optional for team-level plugins) | N       | len=8       |
| uri       | string | repository URI                                                                        | Y       | len<=100    |
| namespace | string | repository namespace                                                                  | Y       | len<=256    |
| name      | string | repository name                                                                       | Y       | len<=256    |

**output parameters：**

> RepoInfo

| Parameter         | Type   | Description                                                     | Require |
| ----------------- | ------ | --------------------------------------------------------------- | ------- |
| repoUUID          | string | repository UUID                                                 | Y       |
| userUUID          | string | linked repository user UUID                                     | Y       |
| uri               | string | repository URI                                                  | Y       |
| namespace         | string | repository namespace                                            | Y       |
| name              | string | repository name                                                 | Y       |
| certificationType | enum   | authentication type (enum: OAUTH、PASSWORD、TOKEN、NONE、OTHER) | Y       |

**2. query all linked code repositories**

```typescript
import { addRepos } from '@ones-op/node-ability'

const toolUUID = 'xxx'
const repoInfos = await queryRepos(toolUUID)
```

The input and output parameters of the method are introduced as follows:

**input parameters：**

| Parameter | Type   | Description                                                                           | Require | Value range |
| --------- | ------ | ------------------------------------------------------------------------------------- | ------- | ----------- |
| toolUUID  | string | UUID of the link code repository type                                                 | Y       | len=8       |
| teamUUID  | string | Team UUID (mandatory for organization-level plugins, optional for team-level plugins) | N       | len=8       |

**output parameters：** RepoInfo[]

> RepoInfo

| Parameter         | Type   | Description                                                     | Require |
| ----------------- | ------ | --------------------------------------------------------------- | ------- |
| repoUUID          | string | repository UUID                                                 | Y       |
| userUUID          | string | linked repository user UUID                                     | Y       |
| uri               | string | repository URI                                                  | Y       |
| namespace         | string | repository namespace                                            | Y       |
| name              | string | repository name                                                 | Y       |
| certificationType | enum   | authentication type (enum: OAUTH、PASSWORD、TOKEN、NONE、OTHER) | Y       |

## Abilities in Different Life Cycle Stages

1. Plugin enabled

- On the option list page of the link repository type, the link type of ability definition is added;
- The link type defined by the ability, the link page of the ability definition will pop up in the next step, and the code repository can be linked through this page;
- After the code repository is successfully linked through the link type defined by the capability, it can be viewed on the code repository management page.
- Through the ability to add the commit and pull request data of the code repository, after the associated work item is successfully displayed under the project. 。

2. Plugin disabled

- On the option list page of the link repository type, the link type defined by the ability will be hidden, and it will be restored next time it is enabled;
- The code repository linked with the ability will be hidden on the code repository management page, and it will be restored next time it is enabled;
- Through the ability to add the commit and pull request data of the code repository, after the associated work item is successfully displayed under the project, it will not be hidden;
- At this time, an error will be reported when calling the SDK method provided by the capability. Pay attention to catching errors or distinguishing between plugin state processing.

3. plugin Uninstalled

- On the option list page of the link repository type, the link type defined by the ability is deleted, and the next installation cannot be restored;
- The code repository linked with the ability is deleted on the code repository management page, and the next installation cannot be restored;
- Through the ability to add the commit and pull request data of the code repository, after the associated work item is successfully displayed under the project, it will not be deleted.
- At this time, an error will be reported when calling the SDK method provided by the capability. Pay attention to catching errors or distinguishing between plugin state processing.
