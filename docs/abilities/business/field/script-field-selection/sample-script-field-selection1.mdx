# Scene 1： Location information property

## Scene description

Uses want to set location information, including country, province, and city, in the issue item properties.
And these properties conform to real constraints with each other, which are implemented using `Plugin fieldGroup` ability.(Examples[Location information FieldGroup](../fieldgroup/location-fieldgroup.md))，this scene only provides the implementation of the script properties themselves。

## Solution

### Implementation idea:

Location information is expressed by adding script properties of three types of country, province, and city to the issue item, which are radio menus. Persist the `fieldUUID` of each script property into the database for later use.

## Plugin development

1. Add related configuration in `{{plugin root directory}}/config/plugin.yaml`

```yaml
service:
  app_id: ...
  name: ability-scriptSelection
  ...
apis:
  - type: addition
    methods:
      - POST
    url: /scriptFieldSearch
    function: GetOptions
```

2. Write the `plugin.sql` file and create `script_field` table to record the corresponding relationship between the `name` and `fieldUUID` of script properties.

```sql
-- SQL 描述文件, 一般用来初始化插件数据库， 可以配合 ImportSql() 使用
-- 注意⚠️：表名需要用 {{}} 括起来
CREATE TABLE IF NOT EXISTS `{{script_field}}`(
    `id` INT(11) AUTO_INCREMENT,
    `fieldUUID` varchar(128) CHARACTER SET latin1 NOT NULL COMMENT 'uuid',
    `name` varchar(128) CHARACTER SET latin1 NOT NULL COMMENT 'name',
    PRIMARY KEY (`id`)
    ) ENGINE = InnoDB DEFAULT CHARSET=latin1 COLLATE=latin1_bin;
```

3. In the `install` method called when the plugin is installed, use the `FieldsAdd` method to add script properties of country, province and city, and persist the uuid of different script properties into the database.

```typescript
export async function Install() {
  Logger.info('[Plugin] Install')
  await importSQL('plugin.sql')
  const fieldUUIDs: any[] = []
  //添加单选类型的脚本属性至工作项
  const issueScriptField = ['Country', 'Province', 'City']
  for (const fieldName of issueScriptField) {
    const FieldsAddProjectRes = await Field.FieldsAdd({
      Name: fieldName,
      Type: 1001, //表示添加单选类型脚本属性
    })
    if (FieldsAddProjectRes.Error) {
      //如果添加失败，抛出异常
      throw new Error('Failed to create property')
    }
    //添加成功返回属性的UUID
    const { UUID: fieldUUID } = FieldsAddProjectRes
    fieldUUIDs.push(fieldUUID)
    Logger.info('fieldUUID:', fieldUUID)
    try {
      const sql =
        'INSERT into script_field(fieldUUID, name) values("' +
        fieldUUID +
        '", "' +
        fieldName +
        '");'
      await exec('insert', sql)
    } catch (error) {
      Logger.error('error: ', error)
    }
  }
  return
}
```

4. In the `GetOptions` method, the script properties of country, province and city are identified according to the corresponding relationship of database records, and the corresponding information is returned.

```typescript
const Countries: string[] = ['America', 'China', 'Japan']
const Provinces: string[] = ['Washington', 'Hawaii', 'Guangdong', 'SiChuan', 'Tokyo']
const Cities: string[] = [
  'Seattle',
  'Olympia',
  'Hilo',
  'Kahului',
  'Dongguan',
  'Shenzhen',
  'Chengdu',
  'Leshan',
  'Hokkaido',
]

export async function GetOptions(request: PluginRequest): Promise<PluginResponse> {
  const body = request?.body as any
  const options: OptionType[] = [] //返回的选项数据
  let field = await getFieldMap()
  console.log(body)
  switch (field.get(body.field_uuid)) {
    case 'Country':
      for (let i in Countries) {
        options.push({
          uuid: Countries[i],
          value: Countries[i],
        })
      }
      break
    case 'Province':
      for (let i in Provinces) {
        options.push({
          uuid: Provinces[i],
          value: Provinces[i],
        })
      }
      break
    case 'City':
      for (let i in Cities) {
        options.push({
          uuid: Cities[i],
          value: Cities[i],
        })
      }
      break
    default:
      break
  }

  return {
    statusCode: 200,
    body: {
      code: 200,
      body: {
        options: options,
      },
    },
  }
}

async function getFieldMap(): Promise<any> {
  let field = new Map()
  try {
    const sql = 'select * from script_field;'
    const result = await select(sql)
    console.log(result)
    result.forEach((f) => {
      field.set(f.fieldUUID, f.name)
      field.set(f.name, f.fieldUUID)
    })
  } catch (error) {
    Logger.error('error: ' + error)
  }
  return field
}
```
