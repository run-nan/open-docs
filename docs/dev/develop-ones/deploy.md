---
sidebar_position: 1
---

# Deploy

As you can see from the previous article, ONES has open sourced both Project and Wiki. You can develop a single project or two projects at the same time. And, you can build in local environment, then produce a tar file.

This article describes how to use operation and maintenance tool to deploy the tar file in your production or test environment. The current environment of ONES includes: Private Deployment Environment and High Availability Environment. Of course, deploy ones-project-web the same as wiki-web. Now, we will introduce how to use operation and maintenance tool to deploy wiki-web from these two environments.

## Deploy wiki-web

### Private Deployment Environment

#### Preparation

Before you start, do the following preparations:

- Private deployment environment device: You already have a private deployment instance, and subsequent operations are performed on the instance device, such as 192.168.100.10.
- Front-end custom tar package: tar package generated by local build, such as ones-wiki-web.tar.gz.
- Operation and maintenance tool: This tool integrates tarballs into private deployment environments, such as onesopenwiki.

The front-end customized tar package and tool need to be uploaded to the private deployment environment device. There are many ways to achieve, commonly used such as scp, xftp. like:

```bash
scp ones-wiki-web.tar.gz user_name@192.168.100.10:/home/user_name
scp onesopenwiki user_name@192.168.100.10:/home/user_name
```

Confirm permissions. The onesopenwiki tool must have executable permissions. The executing user (root as shown in the picture below) must have permissions such as docker commands.
![](../develop-plugin/images/oneswiki_permission.png)

#### Step By Step

##### Execute the onesopenwiki tool to generate a new ones-release image

```bash
./onesopenwiki rebuild --wiki_web_tar=xxx --ones_release_tag=xxx --ones_release_out_tag=xxx
```

• You can get help information by executing the command ./onesopenwiki rebuild --help.

```bash
[root@auto-test zhangyuan]# ./onesopenwiki rebuild --help
Rebuild the new ones-release image based on the customer Wiki Web tar package

Usage:
  onesopenwiki rebuild [flags]

Flags:
      --ones_release_out_tag string   [option]Tag of output ones-release image, format：1.0.yyyymmddxx
      --ones_release_tag string       [require]Tag of input ones-release image
      --wiki_web_tar string           [require]Tar package of ONES.AI Wiki Web，suffix:.tar.gz
```

• wiki_web_tar, required. suffix format: .tar.gz. This parameter specifies the front-end custom tar package.

• ones_release_tag parameter, required. The tag of the mirror ones-release used in the private deployment environment.

View the tags of ones-release through deploy dir:
![](../develop-plugin/images/ones-release-tag-01.png)
View by docker command:
![](../develop-plugin/images/ones-release-tag-02.png)
• ones_release_out_tag parameter, optional. The tag of the new ones-release image after integrating the front-end tar package.

Users can customize the format requirements: 1.0.yyyymmddxx, all numbers, and cannot have the same name as the existing ones-release image tag.

For Example :

```bash
[root@auto-test zhangyuan]# ./onesopenwiki rebuild --wiki_web_tar=ones-wiki-web.tar.gz  --ones_release_tag=0.1.14597
===================================================================================================================
2022-09-11 10:44:47
log: /tmp/ones_open_wiki.log
cmd.checkRedeploy:100 enter
input params:{OnesReleaseTag:0.1.14597 WikiWebTar:ones-wiki-web.tar.gz OnesReleaseOutTag: backReleaseOutTag:}
Auto generate params...
generate params:{OnesReleaseTag:0.1.14597 WikiWebTar:ones-wiki-web.tar.gz OnesReleaseOutTag:1.0.2022081100 backReleaseOutTag:1.0.2022081101}
cmd.checkRedeploy:152 success
workdir:/tmp/ones3003415399
cmd.renderBackDockerfile:155 enter
cmd.renderBackDockerfile:164 success
cmd.buildBackImage:185 enter
Backup image ones-release:0.1.14597 to ones-release:1.0.2022081101
cmd.buildBackImage:197 success
cmd.renderRedeployDockerfile:168 enter
cmd.renderRedeployDockerfile:181 success
cmd.buildRedeployImage:201 enter
Building image ones-release:1.0.2022081100
Building image will take several minutes,Please wait a moment...
cmd.buildRedeployImage:213 success
Please continue to execute the following command to deploy the new image:
	docker images | grep 1.0.2022081100
	enter deployment path(cd /data/ones/...)
	touch 1.0.2022081100.tar && sh upgrade.sh && rm -rf 1.0.2022081100.tar
To rollback the deployment image, execute the following command:
	docker images | grep 1.0.2022081101
	enter deployment path(cd /data/ones/...)
	touch 1.0.2022081101.tar && sh upgrade.sh && rm -rf 1.0.2022081101.tar
===================================================================================================================
```

##### Deploy a new image

Divided into two categories: test environment deployment, production environment deployment. Both, the process is the same, but there are different requirements for the tag number.

Follow the prompts in step 2 to deploy the new image. First cd into the deployment path, and then use upgrade.sh to deploy the new image.

For Example：

```bash
#示例
[root@auto-test ~]# docker images | grep 1.0.2022080102
ones-release                     1.0.2022080102              269507c43b62   5 minutes ago   11.6GB
[root@auto-test ~]# cd /data/ones/pkg/69test_8fa28d
[root@auto-test 69test_8fa28d]# ls
ones-test-0.1.14476  ones-test-0.1.14476.tar.gz
[root@auto-test 69test_8fa28d]# cd ones-test-0.1.14476
[root@auto-test ones-test-0.1.14476]# ls *.sh
env.sh  ones-deploy.sh  private_check.sh  upgrade.sh
[root@auto-test ones-test-0.1.14476]# touch 1.0.2022080102.tar && sh upgrade.sh && rm -rf 1.0.2022080102.tar
Check version
 Umask is 0022, is ok
Disk space is ok
Local version: 1.0.2022080101  online version: 1.0.2022080102
New version found, confirm upgrade: Y/N
y
Start upgrade...
```

##### Verify the result

- Front-end effect verification
- docker commands

```bash
docker ps |grep 443
```

##### Rollback [Optional]

If you need to roll back to the previous environment, follow the prompts in step 2 or view the log content of /tmp/ones_open.log.

```bash
docker images | grep 1.0.2022081101
enter deployment path(cd /data/ones/...)
touch 1.0.2022081101.tar && sh upgrade.sh && rm -rf 1.0.2022081101.tar
```

### High Availability Environment

#### Preparation

Before you start, do the following preparations:

- High-availability environment equipment: k8s operates the machine to achieve high-availability update deployment (such as 192.168.100.10).
- Front-end custom tar package: locally build & generate custom tar package, such as ones-wiki-web.tar.gz.
- Operation and maintenance tools: docker , onesopenwiki.
  Install and configure the [dokcer](https://www.docker.com/products/docker-desktop/) environment locally.

Confirm permission. The onesopenwiki tool must have executable permission。

#### Step By Step

##### Execute the onesopenwiki tool to generate a local image

```bash
./onesopenwiki webimage --wiki_web_out_tag=xxx --wiki_web_tar=xxx
```

• You can get help by executing the command ./onesopenwiki webimage --help.

```bash
[root@auto-test zhangyuan]# ./onesopenwiki webimage --help
Build wiki_web image based on the customer Wiki Web tar package

Usage:
  onesopenwiki webimage [flags]

Flags:
      --wiki_web_out_tag string   [option]Tag of output wiki_web image, format：1.0.yyyymmddxx
      --wiki_web_tar string       [require]Tar package of ONES.AI Wiki Web，suffix:.tar.gz
```

• wiki_web_tar parameter, required, suffix format: .tar.gz. This parameter specifies the front-end custom tar package.

You can refer to Private Deployment get wiki_web_tar param.

• wiki_web_out_tag parameter, optional. According to the front-end tar package, the tag of the mirror wiki-web is generated.

Users can customize the format requirements: 1.0.yyyymmddxx, all numbers, and cannot have the same name as the existing wiki-web mirror tag.

• Executing this command will generate a local image file, which can be viewed through docker images |grep xxx

For Example：

```bash
[root@auto-test zhangyuan]# ./onesopenwiki webimage --wiki_web_tar=ones-wiki-web.tar.gz
===================================================================================================================
2022-09-11 11:11:22
log: /tmp/ones_open_wiki.log
cmd.checkWebImage:51 enter
input params:{WikiWebTar:ones-wiki-web.tar.gz WikiWebOutTag:}
Auto generate params...
generate params:{WikiWebTar:ones-wiki-web.tar.gz WikiWebOutTag:1.0.2022081100}
cmd.checkWebImage:91  success
workdir:/tmp/ones685568270
cmd.renderWebImageDockerfile:126 enter
cmd.renderWebImageDockerfile:138 success
cmd.buildWebImageImage:142 enter
Building image wiki-web:1.0.2022081100
Building image will take several minutes,Please wait a moment...
cmd.buildWebImageImage:154 success
Show the generated image:
	docker images | grep 1.0.2022081100
===================================================================================================================

```

##### Push the image to the public|private repository

If the image is hosted in the public repository Dockerhub, then refer to "method a" to push to the public repository; if it is a customer's private repository, refer to "method b" to push to the private repository.

• Push to public repository

```bash
docker tag wiki-web:1.0.2022080201 onestest/wiki-web:v1.0.0
docker push onestest/wiki-web:v1.0.0
```

![](../develop-plugin/images/onesproject_public.png)

• Push to private repository

Take the private repository 192.168.1.100 as an example:

• Configure trusted private warehouse (optional)

```bash
#Note that if your private repository has a trusted https certificate, you do not need to modify /etc/docker/daemon.json
vim /etc/docker/daemon.json
{
    "insecure-registers":[
        "192.168.1.100"
    ]
}

systemctl restart docker
```

• Login to private repository

```bash
#param u is the login user account; param p is the password of the user.
docker login 192.168.1.100 -u xxx -p xxx
```

• Push to private repository

```bash
docker tag wiki-web:1.0.2022080201  192.168.1.100/project/wiki-web:v1.0.2
docker push 192.168.1.100/project/wiki-web:v1.0.2
```

Login [repository](https://192.168.1.100/) ，and view the image file just uploaded
![](../develop-plugin/images/onesproject_private.png)

##### High availability deployment

Log in to the k8s operation machine and perform the following steps to implement the rolling update operation.

```bash
#Configuration file priority description: config/private.yaml > config/public.yaml > default/config.yaml

#Modify config/private.yaml. Add or modify wikiWebImage

# wikiWebImage: 192.168.1.100/project/wiki-web:v1.0.2
vi /data/ones/ones-ai-k8s/config/private.yaml
# Redeploy the high availability environment
make setup-ones
```

##### Verify the result

• Check the tag of the wiki-web image. Such as:

```bash
kubectl -n ones-namespace  get pods -o yaml |grep image |grep wiki-web
```

• Front-end effect verification

##### Rollback [Optional]

If you need to roll back this deployment, you can do following commands.

```bash
#Revert operation 3 changes back
vi /data/ones/ones-ai-k8s/config/private.yaml

make setup-ones
```

## Deploy ones-project-web

You just need to replace ones-wiki-web.tar.gz with ones-ai-web.tar.gz，and change the operation and maintenance tool onesopenwiki to onesopenproject。

In the High Availability Environment, the configuration item wikiWebIm age is changed to projectWebImage.

Other processes is same as the above documents.
