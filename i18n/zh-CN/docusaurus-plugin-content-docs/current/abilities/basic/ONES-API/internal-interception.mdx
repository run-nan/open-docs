---
sidebar_position: 4
---

import Image from '@theme/IdealImage'

import urlParamImg from './images/urlParam.png'

# ğŸ”’ ONES æ¥å£åŠ«æŒ

:::danger èƒ½åŠ›åºŸå¼ƒè¯´æ˜
æ­¤èƒ½åŠ›è‡ª2023å¹´10æœˆ13å·èµ·å·²åºŸå¼ƒã€‚ç›¸å…³éœ€æ±‚éœ€è¦ç±»ä¼¼èƒ½åŠ›ï¼Œè¯·å‘å¼€æ”¾å¹³å°ææ–°çš„éœ€æ±‚å•ã€‚

:::

## è¦æ±‚

| ONES    |
| :------ |
| v3.6.0+ |

## æ¦‚è¿°

æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦æ”¹å˜ ONES ç³»ç»Ÿä¸­æŸäº›è¡Œä¸ºçš„è¡¨ç°ï¼Œåœ¨æŸä¸ªè¡Œä¸ºå‰åå¢åŠ ä¸€äº›æ“ä½œæˆ–è€…æ›¿æ¢è¡Œä¸ºæœ¬èº«æ¥è¾¾åˆ°ä¸šåŠ¡éœ€æ±‚ã€‚æ’ä»¶å¯ä»¥é€šè¿‡æ¥å£åŠ«æŒèƒ½åŠ›å¯¹ ONES æ ‡å‡†ç³»ç»Ÿä¸­æ‰€æœ‰å¯¹å¤–å¼€æ”¾çš„æ¥å£è¿›è¡ŒåŠ«æŒï¼Œæ”¯æŒå‰ç½®ã€åç½®å’Œæ›¿æ¢æ–¹å¼ï¼›

- **æ›¿æ¢**ï¼šæ’ä»¶å¯ä»¥â€æ›¿æ¢â€œæ ‡å‡†ç³»ç»Ÿç³»ç»Ÿçš„æŸä¸ªæ¥å£ï¼Œè®©æ’ä»¶èƒ½å¤Ÿå¯¹ç°æœ‰ç³»ç»Ÿçš„æŸä¸ªè¯·æ±‚è¿›è¡Œå®Œå…¨çš„è‡ªå®šä¹‰å¤„ç†ã€‚
- **å‰ç½®åŠ«æŒ**ï¼šæ˜¯æŒ‡å½“è¯·æ±‚è¿›å…¥æ ‡å‡†ç³»ç»Ÿæ—¶ï¼Œæœªè¢«å¤„ç†å‰å°±ä¼šå…ˆè¢«è½¬å‘åˆ°æ’ä»¶ï¼Œç”±æ’ä»¶å¯¹è¯·æ±‚è¿›è¡Œä¿®æ”¹åï¼Œå›ä¼ ç»™æ ‡å‡†ç³»ç»Ÿå¹¶ç»§ç»­æ‰§è¡ŒåŸå…ˆçš„é€»è¾‘ã€‚ä¸€èˆ¬ç”¨äºä¿®æ”¹è¯·æ±‚çš„å‚æ•°ï¼Œæˆ–å¯¹è¯·æ±‚è¿›è¡Œæ ¡éªŒï¼›
- **åç½®åŠ«æŒ**ï¼šæ˜¯æŒ‡å½“è¯·æ±‚åœ¨ ONES å®Œæˆå¤„ç†åï¼Œä¼šå‘é€é€šçŸ¥ç»™æ’ä»¶ï¼Œæ’ä»¶æ­¤æ—¶å¯è¿›è¡Œä¸€äº›åç½®å¤„ç†ï¼Œä½†æ— æ³•ä¿®æ”¹å“åº”å†…å®¹ã€‚

**åŠ«æŒ**å’Œ**æ›¿æ¢**éƒ½æ˜¯æ¯”è¾ƒåº•å±‚çš„æ“ä½œï¼Œå¯èƒ½å¯¹ç³»ç»ŸåŠŸèƒ½äº§ç”ŸæœªçŸ¥é£é™©ã€‚ä¸€èˆ¬åªæœ‰åœ¨å…¶å®ƒèƒ½åŠ›éƒ½ä¸æ»¡è¶³éœ€æ±‚çš„æƒ…å†µä¸‹ï¼Œæ‰è€ƒè™‘ä½¿ç”¨æ¥å£åŠ«æŒèƒ½åŠ›ã€‚

:::caution æ³¨æ„
è¯¥èƒ½åŠ›å³å°†é—å¼ƒï¼Œä¸ä¿è¯åç»­å…¼å®¹æ€§ï¼
:::

## ä½¿ç”¨

### ä½¿ç”¨é¡»çŸ¥

1. ç»„ç»‡çº§åˆ«çš„æ¥å£å’Œå›¢é˜Ÿçº§åˆ«çš„æ¥å£çš„å·®åˆ«åœ¨äºå›¢é˜Ÿçº§åˆ«æ¥å£çš„ `url` ä¸­åŒ…å«æœ‰ `/team/:teamUUID`ã€‚å¯¹äºåŒä¸€ä¸ªæ¥å£ï¼šç»„ç»‡çº§åˆ«æ¥å£åªå…è®¸ä¸€ä¸ªæ’ä»¶è¿›è¡ŒåŠ«æŒï¼›å›¢é˜Ÿçº§åˆ«æ¥å£å…è®¸æ¯ä¸ªå›¢é˜Ÿä¸­éƒ½æœ‰ä¸€ä¸ªæ’ä»¶è¿›è¡ŒåŠ«æŒï¼Œä½†åŒä¸ªå›¢é˜Ÿä¸­åªå…è®¸ä¸€ä¸ªæ’ä»¶è¿›è¡ŒåŠ«æŒã€‚
2. åœ¨æœ¬åœ°è°ƒè¯•ä¸­ï¼Œå¦‚æœä¿®æ”¹äº†æ’ä»¶é…ç½®æ–‡ä»¶`config/plugin.yaml`ï¼Œéœ€è¦è¿è¡Œ `npx op invoke clear` å¹¶é‡æ–°è¿è¡Œ `npx op invoke run` æŒ‡ä»¤æ‰èƒ½ä½¿é…ç½®ç”Ÿæ•ˆã€‚

### replace æ¥å£æ›¿æ¢

- è¯·æ±‚æµç¨‹

  ```mermaid
  sequenceDiagram
      autonumber
      ç”¨æˆ·å‰ç«¯->>ONES: è¯·æ±‚
      ONES->>+Plugin: è½¬å‘
      Plugin->>-ONES: è¿”å›
      ONES->>ç”¨æˆ·å‰ç«¯: è¿”å›
  ```

- é…ç½®ç¤ºä¾‹

  åœ¨æ’ä»¶é…ç½®æ–‡ä»¶ä¸­çš„ `apis` å­—æ®µåŠ ä¸Šä»¥ä¸‹é…ç½®ï¼š

  ```yaml title='/config/plugin.yaml'
  apis:
    - type: replace #æ¥å£ç±»å‹ï¼š replace:æ›¿æ¢
      methods: #æ¥å£è¯·æ±‚æ–¹å¼
        - POST
      url: /team/:teamUUID/online_page/:pageUUID/update_title #åŠ«æŒæ¥å£url
      scope: wiki #projectæˆ–wikiæ¥å£ï¼Œæ²¡æœ‰è¯¥å±æ€§åˆ™é»˜è®¤ä¸ºproject
      function: jackFunc #åç§°ä¸ä»£ç é‡Œçš„å‡½æ•°åä¿æŒä¸€è‡´
  ```

- æ·»åŠ å¤„ç†æ–¹æ³•

  è¯¥ç¤ºä¾‹æ›¿æ¢äº† wiki ä¿®æ”¹é¡µé¢æ ‡é¢˜çš„æ¥å£ï¼Œä¼šå°†é¡µé¢æ ‡é¢˜è®¾ç½®ä¸º"plugin title"

  ```typescript
  import { fetchONES } from '@ones-op/node-fetch'
  import { Logger } from '@ones-op/node-logger'

  export async function jackFunc(
    request: PluginRequest<Record<string, any>>,
  ): Promise<PluginResponse> {
    Logger.info('replace success')
    let userUUID = ''
    let userToken = ''
    if (request.headers['Ones-User-Id'] != null) {
      userUUID = request.headers['Ones-User-Id']
      userToken = request.headers['Ones-Auth-Token']
    }
    Logger.info('url:', request.url)
    let response = await fetchONES({
      path: '/wiki' + request.url,
      method: 'POST',
      headers: {
        'Ones-User-Id': [userUUID],
        'Ones-Auth-Token': [userToken],
      },
      body: {
        title: 'plugin title',
      },
      root: false,
    })
    Logger.info(JSON.stringify(response, undefined, 2))
    if (response) {
      return response
    }
    return {
      body: {},
    }
  }
  ```

- æ³¨æ„äº‹é¡¹

  æ¥å£è¯·æ±‚å‚æ•°éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

  - åŠ«æŒçš„æ˜¯ ONES API ï¼Œæ‰€ä»¥å¡«å†™çš„ `url` å¿…é¡»è·Ÿè®¿é—® ONES API çš„ `url` ä¿æŒä¸€è‡´ï¼›

  - ç¡®è®¤è¢«æ›¿æ¢æ¥å£æœ¬èº«æ˜¯ `POST` è¯·æ±‚è¿˜æ˜¯ `GET` è¯·æ±‚ï¼›

  - ç¡®è®¤è¢«æ›¿æ¢æ¥å£è¯·æ±‚å¤´éœ€è¦è®¾ç½®ä»€ä¹ˆå‚æ•°ï¼Œè¯·å‚è€ƒ [ONES API](../../../api/readme) æ–‡æ¡£ï¼›

  - æ’ä»¶ä½¿ç”¨ replace èƒ½åŠ›çš„æ—¶å€™ï¼Œå¦‚æœå¯¹åŸæœ‰çš„åŠ«æŒæ¥å£è¿›ä½¿ç”¨ fetchã€fetchONESã€axios è¯·æ±‚æ—¶ï¼Œè¯·å‹¿ä½¿ç”¨åŸæœ‰çš„è¯·æ±‚å¤´ï¼Œä¸€èˆ¬åªæå– UserID å’Œ UserTokenï¼Œå…¶æ¬¡å¦‚æœæ˜¯å¤šå›¢é˜Ÿçš„ç¯å¢ƒä¸‹ï¼Œä½¿ç”¨ fetchONES æ³¨æ„åœ¨è¯·æ±‚å¤´ä¸ŠåŠ ä¸Šã€teamUUIDã€‘å‚æ•°ï¼Œé¿å…æ’ä»¶å‡ºç° 403 é—®é¢˜ã€‚

### prefix å‰ç½®æ¥å£åŠ«æŒ

- è¯·æ±‚æµç¨‹

  ```mermaid
  sequenceDiagram
      autonumber
      ç”¨æˆ·å‰ç«¯->>+ONES: è¯·æ±‚
      ONES->>+Plugin: è½¬å‘
      Plugin->>Plugin: åšå‰ç½®å¤„ç†
      Plugin->>-ONES: ä¼ å›è¯·æ±‚
      ONES->>ONES: è¯·æ±‚å¤„ç†
      ONES->>-ç”¨æˆ·å‰ç«¯: è¿”å›
  ```

- é…ç½®ç¤ºä¾‹

  åœ¨æ’ä»¶é…ç½®æ–‡ä»¶ä¸­çš„ `apis` å­—æ®µåŠ ä¸Šä»¥ä¸‹é…ç½®ï¼š

  ```yaml title='/config/plugin.yaml'
  apis:
    - type: prefix #æ¥å£ç±»å‹ï¼š prefix:å‰ç½®åŠ«æŒ
      methods:
        - POST
      url: /team/:teamUUID/online_page/:pageUUID/update_title
      scope: wiki
      function: prefixFunc
  ```

- æ·»åŠ å¤„ç†æ–¹æ³•

  è¯¥ç¤ºä¾‹å¯¹ wiki ä¿®æ”¹é¡µé¢æ ‡é¢˜çš„æ¥å£è¿›è¡Œå‰ç½®åŠ«æŒï¼Œåœ¨æœ¬æ¬¡ä¿®æ”¹æ ‡é¢˜ä¸­åŠ ä¸Šåç¼€

  ```typescript
  //prefix å‰ç½®æ¥å£åŠ«æŒ
  export async function prefixFunc(
    request: PluginRequest<Record<string, any>>,
  ): Promise<PluginResponse> {
    let body = request?.body as any
    let headers = request?.headers as any
    body.title = body.title + '-plugin'
    return {
      headers: headers,
      body: body,
    }
  }
  ```

### suffix åç½®æ¥å£åŠ«æŒ

- è¯·æ±‚æµç¨‹

  ```mermaid
  sequenceDiagram
      autonumber
      ç”¨æˆ·å‰ç«¯->>+ONES: è¯·æ±‚
      ONES->>ONES: è¯·æ±‚å¤„ç†
      ONES->>+Plugin: è½¬å‘
      Plugin->>Plugin: åšåç½®å¤„ç†
      Plugin->>-ONES: è¿”å›
      ONES->>-ç”¨æˆ·å‰ç«¯: è¿”å›
  ```

- é…ç½®ç¤ºä¾‹

  åœ¨æ’ä»¶é…ç½®æ–‡ä»¶ä¸­çš„ `apis` å­—æ®µåŠ ä¸Šä»¥ä¸‹é…ç½®ï¼š

  ```yaml title='/config/plugin.yaml'
  apis:
    - type: suffix #æ¥å£ç±»å‹ï¼š suffix:åç½®
      methods:
        - GET
      url: /users/me
      scope: project
      function: suffixFunc
  ```

- æ·»åŠ å¤„ç†æ–¹æ³•

  è¯¥ç¤ºä¾‹è¡¨ç¤ºå½“æ¥å£å®Œæˆå¤„ç†ä¹‹åï¼Œè®°å½•ä¸€äº›å†…å®¹åˆ°`suffix.txt`æ–‡ä»¶ä¸­

  ```typescript
  import { createFile, writeStrings } from '@ones-op/node-file'
  import { Logger } from '@ones-op/node-logger'

  export async function Install() {
    await createFile('./suffix.txt')
    Logger.info('[Plugin] Install')
  }
  //suffix hijacking
  export async function suffixFunc(
    request: PluginRequest<Record<string, any>>,
  ): Promise<PluginResponse> {
    Logger.info('suffix success')
    let body = request?.body as any
    await writeStrings('./suffix.txt', [JSON.stringify(request, undefined, 2)])
    return {
      // å¯ä»¥è¿”å›ä»»æ„ body
      body: {},
    }
  }
  ```

### è‡ªå®šä¹‰ query å‚æ•°

æ”¯æŒå¸¦æœ‰è‡ªå®šä¹‰ query å‚æ•°çš„æ¥å£åŠ«æŒï¼Œå¯¹äºåŒä¸€ä¸ª urlï¼Œå…è®¸é€šè¿‡è¯·æ±‚çš„ query å‚æ•°åšä¸åŒçš„æ¥å£åŠ«æŒæ–¹æ³•å¤„ç†ã€‚ä½ å¯ä»¥åœ¨`config/plugin.yaml`ä¸­çš„`apis`å­—æ®µå†…è®¾ç½®è‡ªå®šä¹‰çš„ query å‚æ•°ï¼Œ
æ‰€æœ‰å¯¹äºè¯¥æ¥å£çš„è¯·æ±‚å¦‚æœå¸¦æœ‰è¿™äº›è®¾å®šå¥½çš„å‚æ•°åˆ™è¯¥è¯·æ±‚è¢«åŠ«æŒï¼Œå¦åˆ™ä¸åŠ«æŒã€‚

<Image img={urlParamImg} />

- åŠ«æŒè§„åˆ™

1. ä¸€ä¸ªæ¥å£åªèƒ½ç”±ä¸€ä¸ªæ’ä»¶è¿›è¡Œä¸€ç§ç±»å‹çš„æ¥å£åŠ«æŒï¼ˆprefix,replace,suffixï¼‰ï¼Œä½†å…è®¸ä¸€ä¸ªæ¥å£å®šä¹‰ä¸åŒçš„ query å‚æ•°ï¼ŒåŒ¹é…ä¸åŒçš„å‡½æ•°å¤„ç†æ–¹æ³•

2. è‡ªå®šä¹‰ query å‚æ•°ä¸ºä¸€ä¸ª key å’Œ value éƒ½ä¸º string çš„ mapï¼Œå½“å¯¹äºè¯¥æ¥å£çš„è¯·æ±‚ä¸­åŒ…å«äº† map ä¸­çš„æ‰€æœ‰ key å’Œ value åˆ™è§¦å‘åŠ«æŒ

3. å½“ä¸€ä¸ªè¯·æ±‚æ»¡è¶³å¤šä¸ªå¸¦æœ‰è‡ªå®šä¹‰ query å‚æ•°çš„æ¥å£åŠ«æŒè§„åˆ™æ—¶ï¼ŒæŒ‰ç…§`config/plugin.yaml`æ–‡ä»¶ä¸­ apis å£°æ˜çš„å…ˆåé¡ºåºä¼˜å…ˆåŒ¹é…å¯¹åº”æ–¹æ³•

- é…ç½®ç¤ºä¾‹

  åœ¨æ’ä»¶é…ç½®æ–‡ä»¶ä¸­çš„ `apis` å­—æ®µåŠ ä¸Šä»¥ä¸‹é…ç½®ï¼š

  ```yaml title='/config/plugin.yaml'
  apis:
    - type: replace
      methods:
        - POST
      scope: project
      url: /users/me
      function: replaceFunc1
      query:
        k1: v1
    - type: replace
      methods:
        - POST
      scope: project
      url: /users/me
      function: replaceFunc2
      query:
        k2: v2
  ```

  - è¯·æ±‚ url: `/users/me?k2=v2` å‘½ä¸­: replaceFunc2

  - è¯·æ±‚ url: `/users/me?k1=v1&k2=v2&k3=v3` æŒ‰ç…§å£°æ˜é¡ºåºåŒ¹é…ï¼Œå‘½ä¸­: replaceFunc1

  - è¯·æ±‚ url: `/users/me` æ— å‘½ä¸­ï¼Œä¸è¿›è¡Œæ¥å£åŠ«æŒï¼Œèµ°åŸå¤„ç†é€»è¾‘

### è°ƒè¯•æ–¹å¼

- ä½¿ç”¨ `curl` å·¥å…·è¿›è¡Œè®¿é—®ï¼Œä»¥`/users/me`æ¥å£ä¸ºä¾‹ï¼š

  ```shell
  curl --location --request GET 'https://yourhost/users/me' \
  --header 'Ones-User-Id: {user_uuid}' \
  --header 'Ones-Auth-Token: {user_token}' \
  --header 'Content-Type: application/json' \
  --data ''
  ```

- ä»£ç è¯·æ±‚å‚æ•°ç¤ºä¾‹

  ```
  urlï¼šhttps://yourhost/users/me
  headers:
      Ones-User-Id:{user_uuid}
      Ones-Auth-Token:{user_token}
      ...
  method: GET
  ```
