(self.webpackChunkopen_docs=self.webpackChunkopen_docs||[]).push([[9132],{66612:(e,n,t)=>{e.exports={src:{srcSet:t.p+"assets/ideal-img/ONES-login-interface.3ecdb82.473.png 473w",images:[{path:t.p+"assets/ideal-img/ONES-login-interface.3ecdb82.473.png",width:473,height:536}],src:t.p+"assets/ideal-img/ONES-login-interface.3ecdb82.473.png",toString:function(){return t.p+"assets/ideal-img/ONES-login-interface.3ecdb82.473.png"},placeholder:void 0,width:473,height:536},preSrc:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAALCAYAAABGbhwYAAAACXBIWXMAAAsTAAALEwEAmpwYAAABFklEQVQYlU2QyU4DMRBE50ORuOaA+BIOiBPbR3DkAEECsQgRCcQSxAWJLCiQZDxOmBnbbT9kT0hoqbxVdVe7M2MFJ4KaC8ednJfXN27vOjw9d7HOE/mIzDohIl563zVKz8lVwWSS48QnLiIT8aQIIW1VVWGMWTyFuOKiMNpaYwi+SSiKgtls9k/ISqi1pixLyqrCWpdIEVkiapJ17EmpAmMcxljKWvhSlpGyqLnDe//XY6wS+4po7FbRfCiL6q2jMes7A1q7QzYPhmzsD2ntfbK23efwJE/JqeL9e0X7QdO+7HNx0+P86oOz6wGnjz90ezWEZC0LCwNOI94RxEA9XZov5+gDOOsIaooaTdCjcTq7AN43c/wFgVGjCE/ge+oAAAAASUVORK5CYII="}},34002:(e,n,t)=>{e.exports={src:{srcSet:t.p+"assets/ideal-img/QR-code-login.3c0fa12.810.png 810w",images:[{path:t.p+"assets/ideal-img/QR-code-login.3c0fa12.810.png",width:810,height:818}],src:t.p+"assets/ideal-img/QR-code-login.3c0fa12.810.png",toString:function(){return t.p+"assets/ideal-img/QR-code-login.3c0fa12.810.png"},placeholder:void 0,width:810,height:818},preSrc:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAACXBIWXMAABYlAAAWJQFJUiTwAAAA9UlEQVQYlVWQy0rFMBiE80AuXPkCPo5upO5EEFeCKOpaRbzhE4gLwVsPinhFNyJd1AoqeETwpG3SJp8kNT2egSH/TIYJ+YWUEq01Ad3uF2n6glLKa2utP4UbggjzgEcDEZrCRQtrm9D/RmMakWVvTE+tE02uEV88eK+ujS/5CxpvJk/vjA6PMTI0zv7B42DQibYx/WAm2iaa2OS889wG26dr0/BH5vSKkrxQ9GSBrgwuZ0JjH25NjhXg1tP/oMi+DRtXmq0bzd698ty9c9Ts3GpWLzXXrzUi+TTMHZXMn5QsxzkrHclSnLN4VrBwWjJ7WHKcVPwCC2R0Zc6U6MYAAAAASUVORK5CYII="}},70174:(e,n,t)=>{e.exports={src:{srcSet:t.p+"assets/ideal-img/QR-code.e61f9cb.1024.png 1024w,"+t.p+"assets/ideal-img/QR-code.5050ed6.1448.png 1448w",images:[{path:t.p+"assets/ideal-img/QR-code.e61f9cb.1024.png",width:1024,height:440},{path:t.p+"assets/ideal-img/QR-code.5050ed6.1448.png",width:1448,height:622}],src:t.p+"assets/ideal-img/QR-code.e61f9cb.1024.png",toString:function(){return t.p+"assets/ideal-img/QR-code.e61f9cb.1024.png"},placeholder:void 0,width:1024,height:440},preSrc:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAECAYAAAC3OK7NAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAg0lEQVQImWPQ9/f/D8J6fn7/DQIC/tvGxPy3j4v7bxQYCBaDyTOACJACNQ+P/zGlpf+XrFjxf97Chf+zm5r+q7i5/TcMCEBVqOru/j+puvr/+vXr/y9duvR/cUfnf2VX1/+GgYEIhSCs6+f33zQk5L9Pevp/38ys/xbh4f91fX3hVgMAM0tPlcvJrcMAAAAASUVORK5CYII="}},20023:(e,n,t)=>{e.exports={src:{srcSet:t.p+"assets/ideal-img/account5.fef9bcf.648.png 648w",images:[{path:t.p+"assets/ideal-img/account5.fef9bcf.648.png",width:648,height:617}],src:t.p+"assets/ideal-img/account5.fef9bcf.648.png",toString:function(){return t.p+"assets/ideal-img/account5.fef9bcf.648.png"},placeholder:void 0,width:648,height:617},preSrc:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAJCAYAAAALpr0TAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAmElEQVQYlYXQ3QrCMAwF4L7/QwpeOGQT+5OuSdrUIxYZkylenIskXwjE3SNhnheICMwMrbVDVBWOiiHGhFoVtdaPtD1kNXgfRvELighcXgtyztvmNzygrBlECfUfDMRIlA/gAGNpiIlQVUdzj3rv4xPCDCdcELxHKWUMX+f1Dce7XlAU7ny64DZN4GVGNxvDLf2BFgP4OuEJd3RfXGDJ3OkAAAAASUVORK5CYII="}},72837:(e,n,t)=>{e.exports={src:{srcSet:t.p+"assets/ideal-img/account6.56e6147.1024.png 1024w,"+t.p+"assets/ideal-img/account6.c81fada.1229.png 1229w",images:[{path:t.p+"assets/ideal-img/account6.56e6147.1024.png",width:1024,height:523},{path:t.p+"assets/ideal-img/account6.c81fada.1229.png",width:1229,height:628}],src:t.p+"assets/ideal-img/account6.56e6147.1024.png",toString:function(){return t.p+"assets/ideal-img/account6.56e6147.1024.png"},placeholder:void 0,width:1024,height:523},preSrc:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAFCAYAAAB8ZH1oAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAdElEQVQImVXNWxLCIAxAUfa/UW0JrSBQ3tehWh0zc/5uEuW9J8aI8wEfIq13xjTGqfd+UiKCtZYQAqUUckq01s6o1vql7rKziXDohWw03Vn4XJuuUVoMbjOE5cahV/Du/ZrZ/xbUqjVPZ0nGUB47I6e/4ApfDK3DDgWr0xwAAAAASUVORK5CYII="}},7931:(e,n,t)=>{e.exports={src:{srcSet:t.p+"assets/ideal-img/add-department.52a0a83.1024.png 1024w,"+t.p+"assets/ideal-img/add-department.86301c9.1954.png 1954w",images:[{path:t.p+"assets/ideal-img/add-department.52a0a83.1024.png",width:1024,height:277},{path:t.p+"assets/ideal-img/add-department.86301c9.1954.png",width:1954,height:528}],src:t.p+"assets/ideal-img/add-department.52a0a83.1024.png",toString:function(){return t.p+"assets/ideal-img/add-department.52a0a83.1024.png"},placeholder:void 0,width:1024,height:277},preSrc:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAACCAYAAABhYU3QAAAACXBIWXMAABYlAAAWJQFJUiTwAAAASElEQVQImR3LSw6AIAxAQe5/RQ/gJ0FFCm0h8EzYzWZC/IyYlDlBVRER1GzZzbiTsB1CqN553sQcg2rOtZ+0nFeQUujNGc34AWK6TV6Ht7a/AAAAAElFTkSuQmCC"}},53974:(e,n,t)=>{e.exports={src:{srcSet:t.p+"assets/ideal-img/application-info.3127263.1024.png 1024w,"+t.p+"assets/ideal-img/application-info.f8999d6.2560.png 2560w",images:[{path:t.p+"assets/ideal-img/application-info.3127263.1024.png",width:1024,height:556},{path:t.p+"assets/ideal-img/application-info.f8999d6.2560.png",width:2560,height:1390}],src:t.p+"assets/ideal-img/application-info.3127263.1024.png",toString:function(){return t.p+"assets/ideal-img/application-info.3127263.1024.png"},placeholder:void 0,width:1024,height:556},preSrc:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAFCAYAAAB8ZH1oAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAeklEQVQImV2OSwrCQBAF5/5XdKXZRI0BjUlPf6ZLJgRBFwVvURSvjPc3qyjDMGLu+EFE0CIwc1SNMs0ry2vlfLqQrqQq6UZmfmmtUUQVF8HqRvZSF6uQrf2JInitPG9X9NgZ8VPMbJRtE1wrMj/o9aq6fzWznXBjWiofHWfDd3MbZc8AAAAASUVORK5CYII="}},57979:(e,n,t)=>{e.exports={src:{srcSet:t.p+"assets/ideal-img/create-application.abc2ac2.1024.png 1024w,"+t.p+"assets/ideal-img/create-application.06ba0bb.2560.png 2560w",images:[{path:t.p+"assets/ideal-img/create-application.abc2ac2.1024.png",width:1024,height:561},{path:t.p+"assets/ideal-img/create-application.06ba0bb.2560.png",width:2560,height:1402}],src:t.p+"assets/ideal-img/create-application.abc2ac2.1024.png",toString:function(){return t.p+"assets/ideal-img/create-application.abc2ac2.1024.png"},placeholder:void 0,width:1024,height:561},preSrc:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAYAAAD68A/GAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAp0lEQVQImV3NzQ7BQBiF4d64iDSdzh8huijX4R4ssaDTwRXYWPhtmVeGhMSXnM05T/IlnVQj8pic4WhMWZZMpxOKokBrjRCCbqpIMqFQSpOmGYvlitPpzO3esl5vkFK+cS8zJNYarLUopaiqiuM10ARwfvfu4jbo2wjtB0qJc47N4UHzBO/9F8Z8YXxT1zVN+ySEwH77g9r8Qedq4l1amM09Rn9gTxheKwezAd5SAXAAAAAASUVORK5CYII="}},6900:(e,n,t)=>{e.exports={src:{srcSet:t.p+"assets/ideal-img/nailing-login-sequence-diagram.daf14b8.1024.png 1024w,"+t.p+"assets/ideal-img/nailing-login-sequence-diagram.19a25d8.1748.png 1748w",images:[{path:t.p+"assets/ideal-img/nailing-login-sequence-diagram.daf14b8.1024.png",width:1024,height:689},{path:t.p+"assets/ideal-img/nailing-login-sequence-diagram.19a25d8.1748.png",width:1748,height:1176}],src:t.p+"assets/ideal-img/nailing-login-sequence-diagram.daf14b8.1024.png",toString:function(){return t.p+"assets/ideal-img/nailing-login-sequence-diagram.daf14b8.1024.png"},placeholder:void 0,width:1024,height:689},preSrc:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAHCAYAAAAxrNxjAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAoUlEQVQYlS2OCY7EMAgE8/9/rhLNeg4nvg3UrskgoUaoKXpTEeacgKLaWWWmiDTMDHUVNpVBzYmSAqPuqBq9nZTrxw9q3pGZ2cCQURmtccWTkhM1X5iI07FbNsfPhs1OfP0SHgf5fCGj3T6dTnbjGlZJr8TPmxAC8f3kGR6Mmlbor1HFgy/1gznJV+Q4dnpJ/v9LvFtn9witVWrJPvvun/gHyi8SRhGLffEAAAAASUVORK5CYII="}},771:(e,n,t)=>{e.exports={src:{srcSet:t.p+"assets/ideal-img/redirect-url.2e3ae81.1024.png 1024w,"+t.p+"assets/ideal-img/redirect-url.eb01c22.2560.png 2560w",images:[{path:t.p+"assets/ideal-img/redirect-url.2e3ae81.1024.png",width:1024,height:560},{path:t.p+"assets/ideal-img/redirect-url.eb01c22.2560.png",width:2560,height:1399}],src:t.p+"assets/ideal-img/redirect-url.2e3ae81.1024.png",toString:function(){return t.p+"assets/ideal-img/redirect-url.2e3ae81.1024.png"},placeholder:void 0,width:1024,height:560},preSrc:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAFCAYAAAB8ZH1oAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAeElEQVQImV3NWwrDMAxEUe9/o6UpoXk4iS1pdEtM+1PBQQwCTXlMO82Dbd/p5rg7ETFIMfKtLO8VtZOzVsyMCCFp7KkmSsaUJojXk2N5c3Wjf13NcBeZyWWirPNCWzfq/fGuVY7jj5TMhyh123EPutmo/Ecm62l8AFDyw+rG6ZzfAAAAAElFTkSuQmCC"}},34356:(e,n,t)=>{"use strict";t.r(n),t.d(n,{assets:()=>k,contentTitle:()=>f,default:()=>U,frontMatter:()=>A,metadata:()=>y,toc:()=>b});var i=t(87462),a=(t(67294),t(3905)),r=t(15944),o=t(7931),s=t.n(o),p=t(53974),l=t.n(p),d=t(57979),g=t.n(d),c=(t(6900),t(66612)),h=t.n(c),u=(t(34002),t(70174),t(771)),m=t.n(u);t(20023),t(72837);const A={},f="Scene\uff1aONES integrate with Ding Talk system",y={unversionedId:"abilities/business/account/synchronize-with-third-party-system/sample-synchronize-with-third-party-system1",id:"version-1.x/abilities/business/account/synchronize-with-third-party-system/sample-synchronize-with-third-party-system1",title:"Scene\uff1aONES integrate with Ding Talk system",description:"Scene Description",source:"@site/versioned_docs/version-1.x/abilities/business/account/synchronize-with-third-party-system/sample-synchronize-with-third-party-system1.mdx",sourceDirName:"abilities/business/account/synchronize-with-third-party-system",slug:"/abilities/business/account/synchronize-with-third-party-system/sample-synchronize-with-third-party-system1",permalink:"/docs/abilities/business/account/synchronize-with-third-party-system/sample-synchronize-with-third-party-system1",draft:!1,tags:[],version:"1.x",lastUpdatedBy:"liupengfei",lastUpdatedAt:1690791943,formattedLastUpdatedAt:"Jul 31, 2023",frontMatter:{},sidebar:"abilities",previous:{title:"Synchronize with third-party system",permalink:"/docs/abilities/business/account/synchronize-with-third-party-system/"},next:{title:"Field",permalink:"/docs/abilities/business/field/"}},k={},b=[{value:"Scene Description",id:"scene-description",level:2},{value:"Solution",id:"solution",level:2},{value:"ability statement",id:"ability-statement",level:3},{value:"Third-party system access",id:"third-party-system-access",level:3},{value:"prerequisite",id:"prerequisite",level:4},{value:"Third party login",id:"third-party-login",level:4},{value:"Departmental synchronization",id:"departmental-synchronization",level:4}],w={toc:b};function U(e){let{components:n,...t}=e;return(0,a.kt)("wrapper",(0,i.Z)({},w,t,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"sceneones-integrate-with-ding-talk-system"},"Scene\uff1aONES integrate with Ding Talk system"),(0,a.kt)("h2",{id:"scene-description"},"Scene Description"),(0,a.kt)("p",null,"Users want to synchronize the organizational structure and personnel information in the Ding Talk to the ONES, and they can directly login to the ONES by scanning the QR code."),(0,a.kt)("h2",{id:"solution"},"Solution"),(0,a.kt)("h3",{id:"ability-statement"},"ability statement"),(0,a.kt)("p",null,"Add the following code to the plugin configuration file\n",(0,a.kt)("inlineCode",{parentName:"p"},"config/plugin.yaml")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="config/plugin.yaml"',title:'"config/plugin.yaml"'},"service: ...\nabilities:\n  - id: ...\n    name: account\n    abilityType: account\n    version: 1.0.0\n    function:\n      sendMessage: SendMessage\n      createLoginUrl: CreateLoginUrl # create redirect login URL\n      doExchangeUser: DoExchangeUser # obtain login user information\n      doPullData: DoPullData # synchronize third-party system user data\n    config:\n      # whether the login function is realized\n      - key: canLogin\n        show: false\n        value: true\n        # whether the synchronization function is realized\n      - key: canSync\n        show: false\n        value: true\n        # whether the function of sending messages is realized\n      - key: canMessage\n        show: false\n        value: true\n        # the logo address of the third party login, which is the name of the file, which is required to be placed in the root directory of the front-end resource, web/dist/\n      - key: logo\n        show: false\n        value: logo.svg\n        # third party login name\n      - key: title\n        show: false\n        value: Account-SSO\n        # third party description\n      - key: desc\n        show: false\n        value: Account-SSO\n        # third party description\n      - key: detailTip\n        show: false\n        value: Account-SSO\n        # third party configuration reminder\n      - key: configTip\n        show: false\n        value: Account-SSO\n")),(0,a.kt)("h3",{id:"third-party-system-access"},"Third-party system access"),(0,a.kt)("h4",{id:"prerequisite"},"prerequisite"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Register Ding Talk account"),(0,a.kt)("p",{parentName:"li"},"Log in to the Ding Talk (this step does not provide detailed operation)")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Create H5 micro-application"),(0,a.kt)("p",{parentName:"li"},"The Ding Talk OAuth2.0 authorization login allows the Ding Talk user to use the Ding Talk identity to securely log in to the ONES. After the Ding Talk user authorization login has been connected to the Ding Talk OAuth2.0, the plugin can obtain the user's interface call credential sns_token, and the sns_token can be used to call the Ding Talk open platform authorization relationship API, so as to obtain the basic open information of the Ding Talk user and help the user to achieve the basic open function."))),(0,a.kt)(r.Z,{img:g(),mdxType:"Image"}),(0,a.kt)("p",null,"After the creation is successful, find the application information under the application page, and record the AgentId, AppKey and AppSecret of the internal application of the Ding talk enterprise."),(0,a.kt)(r.Z,{img:l(),mdxType:"Image"}),(0,a.kt)("p",null,"Find ",(0,a.kt)("inlineCode",{parentName:"p"},"\u5e94\u7528\u529f\u80fd -> \u767b\u5f55\u4e0e\u5206\u4eab -> \u63a5\u5165\u767b\u5f55")," at the bottom of the application interfac.The domain name entered in the input box is the ",(0,a.kt)("strong",{parentName:"p"},"ONES instance domain")," that is called back after being logged in."),(0,a.kt)(r.Z,{img:m(),mdxType:"Image"}),(0,a.kt)("h4",{id:"third-party-login"},"Third party login"),(0,a.kt)("p",null,"The log-in sequence of third-party users is as follows"),(0,a.kt)("mermaid",{value:"sequenceDiagram\n    autonumber\n    actor u as User\n    participant o as ONES\n    participant d as Dingding\n    participant os as ONES Server\n\n    u->>o: Request login to ONES\n    o->>d: Request The Ding Talk OAuth2.0 login\n    d--\x3e>u: Request the user to confirm\n    u->>d: User confirmation\n    d->>o: Redirect to ONES and bring temporary ticket\uff08code\uff09\n    o->>os: Obtain user information according to temporary ticket\n    os->>d: Call the API to get authorized user information\n    d->>os: Return authorized user information\n    os->>o: Return login user information"}),(0,a.kt)("p",null,"After entering the login page of ONES, click the Ding Talk login entry provided by the plugin."),(0,a.kt)(r.Z,{img:h(),mdxType:"Image"}),(0,a.kt)("p",null,"Log in using the Ding Talk scan QR code and confirm the authorization to log in on the mobile phone"),(0,a.kt)("p",null,"Through the previous operation steps, the developer has completed the operation steps from step 1 to step 4 in the sequence diagram, and the specific implementation of these steps is in the ",(0,a.kt)("inlineCode",{parentName:"p"},"CreateLoginUrl()")," method in the plugin code."),(0,a.kt)("admonition",{type:"caution"},(0,a.kt)("ul",{parentName:"admonition"},(0,a.kt)("li",{parentName:"ul"},"Every time you click on the Ding Talk scan login entry provided by the plugin, you will first enter the interior of the ",(0,a.kt)("inlineCode",{parentName:"li"},"CreateLoginUrl()")," method. The main function of this method is to create a third-party login URL.For more information on the construction format of the URL,please refer ",(0,a.kt)("a",{parentName:"li",href:"https://open.dingtalk.com/document/orgapp-server/scan-qr-code-to-log-on-to-third-party-websites"},"Ding Talk scan QR code login"),"\u3002"),(0,a.kt)("li",{parentName:"ul"},"The request in the ",(0,a.kt)("inlineCode",{parentName:"li"},"CreateLoginUrl()")," method already contains the URL for redirecting ONES. You can use the following code to encode the redirected URL with urlencode."))),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-tsx"},"type CreateLoginUrlResponse = {\n  url: string\n}\n\n// Login\nexport async function CreateLoginUrl(request: PluginRequest): Promise<PluginResponse> {\n  Logger.info('Welcome to Login')\n  let respUrl: string = ''\n  let response: CreateLoginUrlResponse = {\n    url: '',\n  }\n  if (typeof request?.body == 'object' && !Array.isArray(request?.body)) {\n    let redirectUrl: string = request?.body.redirect_url\n    Logger.info('redirectUrl:', redirectUrl)\n    let loginUrl = new URL(DindDing_LoginURL)\n    loginUrl.searchParams.append('response_type', 'code')\n    loginUrl.searchParams.append('scope', 'snsapi_login')\n    loginUrl.searchParams.append('state', 'STATE')\n    loginUrl.searchParams.append('appid', AppKey) // AppKey\n    loginUrl.searchParams.append('redirect_uri', redirectUrl)\n    respUrl = loginUrl.toString()\n    Logger.info('respUrl: ', respUrl)\n    response.url = respUrl\n    return CreateLoginUrlRespData(200, '200', '', '', '', response)\n  }\n  return CreateLoginUrlRespData(500, '', '', '', '', response)\n}\n\nfunction CreateLoginUrlRespData(\n  code: number,\n  errcode,\n  model,\n  reason,\n  type: Object,\n  body: CreateLoginUrlResponse\n): PluginResponse {\n  return {\n    body: {\n      code,\n      errcode,\n      model,\n      reason,\n      type,\n      body,\n    },\n  }\n}\n")),(0,a.kt)("admonition",{type:"caution"},(0,a.kt)("ul",{parentName:"admonition"},(0,a.kt)("li",{parentName:"ul"},"After the temporary authorization is obtained by scanning the code, the page will be called back to the login page of ONES.Next, the developer needs to implement the steps such as obtaining user information according to temporary authorization ticket,calling API to obtain authorized user information and returning login user information in the ",(0,a.kt)("inlineCode",{parentName:"li"},"DoExchangeUser()")," method.For more information on calling APIs,please see ",(0,a.kt)("a",{parentName:"li",href:"https://open.dingtalk.com/document/orgapp-server/obtain-the-user-information-based-on-the-sns-temporary-authorization"},"obtain-the-user-information-based-on-the-sns-temporary-authorization"),"."),(0,a.kt)("li",{parentName:"ul"},"When the Ding Talk is recalled to the ONES login page, the temporary authorization code can be obtained in the request of the ",(0,a.kt)("inlineCode",{parentName:"li"},"DoExchangeUser()")," method. When the user information is returned in the format of ",(0,a.kt)("inlineCode",{parentName:"li"},"DoExchangeUserResponse")," in the code,the third-party system user can successfully log in to ONES."))),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-tsx"},"// Get login user information\nexport async function DoExchangeUser(request: PluginRequest): Promise<PluginResponse> {\n  Logger.info('DoExchangeUser Come in')\n  let resp: DoExchangeUserResponse = {\n    third_party_id: '',\n    name: '',\n    title: '',\n    avatar: '',\n    email: '',\n    phone: '',\n  }\n  Logger.info('Request:', request?.body)\n\n  // Parse the request body and parse the code\n  let code: string = getCode(request)\n  Logger.info('Request Code:', code)\n\n  // Get Application token\n  let token = await getToken()\n  if (token == '') {\n    return DoExchangeUserRespData(500, '', '', 'token missing', 'plugin', resp)\n  }\n  Logger.info('Token:', token)\n\n  // Obtain user UnionID through temporary authorization code\n  let uniod = (await getUserInfoByCode(code)) as any\n  if (uniod == '' || uniod == undefined) {\n    return DoExchangeUserRespData(500, '', '', 'uniod missing', 'plugin', resp)\n  }\n  Logger.info('Uniod:', uniod)\n\n  // Get user UUID through user UnionID\n  let userID = (await getUserIDByUnionID(uniod, token)) as any\n  if (userID == '' || userID == undefined) {\n    return DoExchangeUserRespData(500, '', '', 'userID missing', 'plugin', resp)\n  }\n  Logger.info('UserID:', userID)\n\n  // Get user information through user UUID\n  let userInfo = (await getUser(userID, token)) as any\n  Logger.info('UserInfo:', userInfo)\n  ;(resp.third_party_id = userInfo?.userid),\n    (resp.name = userInfo?.name),\n    (resp.title = userInfo?.position),\n    (resp.avatar = userInfo?.avatar),\n    (resp.email = userInfo?.email),\n    (resp.phone = userInfo?.mobile)\n  Logger.info('Login User:', resp)\n\n  // Return login user information\n  return DoExchangeUserRespData(200, '', '', '', '', resp)\n}\n\nexport function getCode(request: PluginRequest) {\n  // Logger.info(request)\n  if (typeof request?.body == 'object' && !Array.isArray(request?.body)) {\n    let authInfo = request.body.auth_info\n    let obj = JSON.parse(authInfo)\n    return obj.code\n  }\n  return ''\n}\n\n// Get the enterprise token\nexport async function getToken(): Promise<string> {\n  Logger.info('Getting enterprise application token...')\n  try {\n    // url of login\n    const url = 'https://oapi.dingtalk.com/gettoken' + `?appkey=${Appsecret}&appsecret=${Secret}`\n    Logger.info('request =====', url)\n    const response = await fetchHttp({\n      url: url,\n      method: 'GET',\n    })\n    let body = (response?.body as Record<string, any>) || ''\n    const AccessToken = body?.access_token || ''\n    const ExpiresIn = body?.expires_in || 0\n    if (AccessToken == '') {\n      Logger.info('Failed to get token::', body)\n      return ''\n    }\n    Logger.info('token:', AccessToken)\n    Logger.info('expires_in', ExpiresIn)\n    Logger.info('insert_sql sql:', insert_sql)\n    Logger.info('token obtained successfully')\n    return AccessToken\n  } catch (error) {\n    Logger.info('token exception error::', error)\n    return ''\n  }\n}\n\nfunction DoExchangeUserRespData(\n  code: number,\n  errcode,\n  model,\n  reason,\n  type: Object,\n  body: DoExchangeUserResponse\n): PluginResponse {\n  return {\n    body: {\n      code,\n      errcode,\n      model,\n      reason,\n      type,\n      body,\n    },\n  }\n}\n")),(0,a.kt)("h4",{id:"departmental-synchronization"},"Departmental synchronization"),(0,a.kt)("p",null,"The prerequisite for department users to synchronize directories is that ",(0,a.kt)("strong",{parentName:"p"},"users who need a third-party system have been successfully activated on the ONES system"),"."),(0,a.kt)("p",null,"In the ",(0,a.kt)("inlineCode",{parentName:"p"},"DoPullData()")," method,you need to ",(0,a.kt)("strong",{parentName:"p"},"obtain the department and user information of the third-party system"),",and the returned content can be based on the code comment structure."),(0,a.kt)("admonition",{type:"caution"},(0,a.kt)("ul",{parentName:"admonition"},(0,a.kt)("li",{parentName:"ul"},'ID of root department must be "- 1"\uff1b'),(0,a.kt)("li",{parentName:"ul"},"Not all department information can be synchronized. Currently, only all user information under ",(0,a.kt)("strong",{parentName:"li"},"root department")," is supported."),(0,a.kt)("li",{parentName:"ul"},"Developers can call the create department API and add users to the department interface in the synchronization code to assign synchronized users to a department."),(0,a.kt)("li",{parentName:"ul"},"Developers or team managers manually manage synchronized users to different departments."))),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-tsx"},"// Synchronization information\n// departments: [  //Returns a list of departments, which must have a department with an id of-1, which is the root department\n//      {\n//           third_party_id: \"-1\",  // The only id in the department\n//           name: agent?.name,     // Department name\n//           parent_id: \"\",         // Parent department id\n//           next_id: \"\"            // In the same level department, the id of the next department\n//      }\n//     ...\n// ]\n// users: [\n//          {\n//           third_party_id: userid,       // user id\n//           name: userInfo?.name,         // user name\n//           email: userInfo?.email,       // user email\n//           title: userInfo?.position,    // user position\n//           department_ids: [\"-1\"]        // department id\n//          }\n//   ...\n// ]\nexport async function DoPullData(request: PluginRequest): Promise<PluginResponse> {\n  const body = request.body || {}\n  let resp: DoPullDataResponse = {\n    departments: [],\n    users: [],\n  }\n\n  // Get enterprise application token\n  let token = await getToken()\n  if (token == '') {\n    Logger.info('Failed to get token')\n    return DoPullDataRespData(500, '', '', '', '', resp)\n  }\n\n  // Get root department details\n  let agent = await getRootDepartmentInfo(token)\n  if (agent == '') {\n    return DoPullDataRespData(500, '', '', '', '', resp)\n  }\n  Logger.info('agent:', agent?.name)\n\n  // Suppose there is only one root department, the department information must have a root department, and the root department id is \"- 1\"\n  let rootDepartment = {\n    third_party_id: '-1',\n    name: agent?.name,\n    parent_id: '',\n    next_id: '',\n  }\n\n  let departments: DepartmentInfo[] = []\n  // Append root department ID\n  departments[0] = rootDepartment\n\n  // all users\n  let userInfos: UserInfo[] = []\n\n  // Obtain user information related to the department (provide user information according to actual business needs)\n  let departUserInfos = await listDepartmentUsers('1', token)\n\n  for (let i = 0; i < departUserInfos.length; i++) {\n    //Query the list of departments according to the user's ID\n    let userInfo = (await getUser(departUserInfos[i]?.userid, token)) as any\n    userInfos.push({\n      third_party_id: userInfo?.userid,\n      name: userInfo?.name,\n      email: userInfo?.email,\n      title: userInfo?.title,\n      department_ids: ['-1'], //root department\n      company: 'ONES',\n      id_number: userInfo?.job_number,\n    })\n  }\n\n  Logger.info('departments:', departments)\n  Logger.info('userInfos:', userInfos)\n  resp.departments = departments\n  resp.users = userInfos\n  return DoPullDataRespData(200, '', '', '', '', resp)\n}\n\n// Get the enterprise token\nexport async function getToken(): Promise<string> {\n  Logger.info('Getting enterprise application token...')\n  try {\n    // url of login\n    const url = 'https://oapi.dingtalk.com/gettoken' + `?appkey=${Appsecret}&appsecret=${Secret}`\n    Logger.info('request =====', url)\n    const response = await fetchHttp({\n      url: url,\n      method: 'GET',\n    })\n    let body = (response?.body as Record<string, any>) || ''\n    const AccessToken = body?.access_token || ''\n    const ExpiresIn = body?.expires_in || 0\n    if (AccessToken == '') {\n      Logger.info('Failed to get token::', body)\n      return ''\n    }\n    Logger.info('token:', AccessToken)\n    Logger.info('expires_in', ExpiresIn)\n    Logger.info('insert_sql sql:', insert_sql)\n    Logger.info('token obtained successfully')\n    return AccessToken\n  } catch (error) {\n    Logger.info('token exception error::', error)\n    return ''\n  }\n}\n\nfunction DoPullDataRespData(\n  code: number,\n  errcode,\n  model,\n  reason,\n  type: Object,\n  body: DoPullDataResponse\n): PluginResponse {\n  return {\n    body: {\n      code,\n      errcode,\n      model,\n      reason,\n      type,\n      body,\n    },\n  }\n}\n")),(0,a.kt)("p",null,"In the member management page, manually add synchronized users to the specified department, use third-party integrated synchronization users, the suffix will have the identity of the plugin."),(0,a.kt)(r.Z,{img:s(),mdxType:"Image"}))}U.isMDXComponent=!0}}]);