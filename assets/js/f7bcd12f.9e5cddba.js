"use strict";(self.webpackChunkopen_docs=self.webpackChunkopen_docs||[]).push([[5774],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>d});var o=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},r=Object.keys(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=o.createContext({}),p=function(e){var t=o.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=p(e.components);return o.createElement(s.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},m=o.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),m=p(n),d=a,g=m["".concat(s,".").concat(d)]||m[d]||c[d]||r;return n?o.createElement(g,i(i({ref:t},u),{},{components:n})):o.createElement(g,i({ref:t},u))}));function d(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,i=new Array(r);i[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:a,i[1]=l;for(var p=2;p<r;p++)i[p]=n[p];return o.createElement.apply(null,i)}return o.createElement.apply(null,n)}m.displayName="MDXCreateElement"},27305:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>c,frontMatter:()=>r,metadata:()=>l,toc:()=>p});var o=n(87462),a=(n(67294),n(3905));const r={sidebar_position:2},i="Deploy",l={unversionedId:"deploy/deploy",id:"deploy/deploy",title:"Deploy",description:"As you can see from the previous article, ONES has open sourced both Project and Wiki. You can develop a single project or two projects at the same time. And, you can build in local environment, then produce a tar file.",source:"@site/project/deploy/deploy.md",sourceDirName:"deploy",slug:"/deploy/",permalink:"/open-docs/project/deploy/",draft:!1,tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"deploy"},s={},p=[{value:"Deploy wiki-web",id:"deploy-wiki-web",level:2},{value:"Private Deployment Environment",id:"private-deployment-environment",level:3},{value:"Preparation",id:"preparation",level:4},{value:"Step By Step",id:"step-by-step",level:4},{value:"Execute the onesopenwiki tool to generate a new ones-release image",id:"execute-the-onesopenwiki-tool-to-generate-a-new-ones-release-image",level:5},{value:"Deploy a new image",id:"deploy-a-new-image",level:5},{value:"Verify the result",id:"verify-the-result",level:5},{value:"Rollback Optional",id:"rollback-optional",level:5},{value:"High Availability Environment",id:"high-availability-environment",level:3},{value:"Preparation",id:"preparation-1",level:4},{value:"Step By Step",id:"step-by-step-1",level:4},{value:"Execute the onesopenwiki tool to generate a local image",id:"execute-the-onesopenwiki-tool-to-generate-a-local-image",level:5},{value:"Push the image to the public|private repository",id:"push-the-image-to-the-publicprivate-repository",level:5},{value:"High availability deployment",id:"high-availability-deployment",level:5},{value:"Verify the result",id:"verify-the-result-1",level:5},{value:"Rollback Optional",id:"rollback-optional-1",level:5},{value:"Deploy ones-project-web",id:"deploy-ones-project-web",level:2}],u={toc:p};function c(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,o.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"deploy"},"Deploy"),(0,a.kt)("p",null,"As you can see from the previous article, ONES has open sourced both Project and Wiki. You can develop a single project or two projects at the same time. And, you can build in local environment, then produce a tar file."),(0,a.kt)("p",null,"This article describes how to use operation and maintenance tool to deploy the tar file in your production or test environment. The current environment of ONES includes: Private Deployment Environment and High Availability Environment. Of course, deploy ones-project-web the same as wiki-web. Now, we will introduce how to use operation and maintenance tool to deploy wiki-web from these two environments."),(0,a.kt)("h2",{id:"deploy-wiki-web"},"Deploy wiki-web"),(0,a.kt)("h3",{id:"private-deployment-environment"},"Private Deployment Environment"),(0,a.kt)("h4",{id:"preparation"},"Preparation"),(0,a.kt)("p",null,"Before you start, do the following preparations:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Private deployment environment device: You already have a private deployment instance, and subsequent operations are performed on the instance device, such as 192.168.100.10."),(0,a.kt)("li",{parentName:"ul"},"Front-end custom tar package: tar package generated by local build, such as ones-wiki-web.tar.gz."),(0,a.kt)("li",{parentName:"ul"},"Operation and maintenance tool: This tool integrates tarballs into private deployment environments, such as onesopenwiki.")),(0,a.kt)("p",null,"The front-end customized tar package and tool need to be uploaded to the private deployment environment device. There are many ways to achieve, commonly used such as scp, xftp. like:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"scp ones-wiki-web.tar.gz user_name@192.168.100.10:/home/user_name\nscp onesopenwiki user_name@192.168.100.10:/home/user_name\n")),(0,a.kt)("p",null,"Confirm permissions. The onesopenwiki tool must have executable permissions. The executing user (root as shown in the picture below) must have permissions such as docker commands."),(0,a.kt)("h4",{id:"step-by-step"},"Step By Step"),(0,a.kt)("h5",{id:"execute-the-onesopenwiki-tool-to-generate-a-new-ones-release-image"},"Execute the onesopenwiki tool to generate a new ones-release image"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"cd ${deployment package directory}\n./onesopenwiki rebuild --wiki_web_tar=xxx --ones_release_tag=xxx --ones_release_out_tag=x.x.x.sp-x.x.x\nor\n./onesopenwiki rebuild --wiki_web_tar=xxx --ones_release_tag=xxx --ones_release_out_tag_major_version=x.x\n")),(0,a.kt)("p",null,"\u2022 You can get help information by executing the command ./onesopenwiki rebuild --help."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"[root@auto-test zhangyuan]# ./onesopenwiki rebuild --help\nRebuild the new ones-release image based on the customer Wiki Web tar package\n\nUsage:\n  onesopenwiki rebuild [flags]\n\nFlags:\n      --ones_release_out_tag string   [option]Tag of output ones-release image, format\uff1a${currentVersion}.sp-${ones_release_out_tag_major_version}.${number}\n      --ones_release_tag string       [require]Tag of input ones-release image\n      --wiki_web_tar string           [require]Tar package of ONES.AI Wiki Web\uff0csuffix:.tar.gz\n      --ones_release_out_tag_major_version string [require]Tag of output ones-release image tag major_version format: x.x\n")),(0,a.kt)("p",null,"\u2022 wiki_web_tar, required. suffix format: .tar.gz. This parameter specifies the front-end custom tar package."),(0,a.kt)("p",null,"\u2022 ones_release_tag parameter, required. The tag of the mirror ones-release used in the private deployment environment."),(0,a.kt)("p",null,"View the tags of ones-release through deploy dir:"),(0,a.kt)("p",null,"View by docker command:"),(0,a.kt)("p",null,"\u2022 ones_release_out_tag parameter, optional. The tag of the new ones-release image after integrating the front-end tar package."),(0,a.kt)("p",null,"Users can customize the format requirements: ${ current version}.sp-${custom version}(3.6.6.sp-1.0.0|3.6.7.8.sp-1.0.1), and cannot have the same name as the existing ones-release image tag."),(0,a.kt)("p",null,"For Example :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"#\u793a\u4f8b\n[root@auto-test ones-test-0.1.15420]# ./onesopenwiki rebuild --wiki_web_tar=ones-wiki-web.tar.gz  --ones_release_tag=0.1.15420 --ones_release_out_tag_major_version=1.0\n===================================================================================================================\n2022-11-11 12:06:45\nlog: /tmp/ones_open_web.log\ncmd.checkRedeploy:101 enter\ninput params:{OnesReleaseTag:0.1.15420 ProjectWebTar:ones-wiki-web.tar.gz OnesReleaseOutTag: }\nAuto generate params...\ngenerate params:{OnesReleaseTag:0.1.15420 ProjectWebTar:ones-wiki-web.tar.gz OnesReleaseOutTag: OnesReleaseOutTagMajorVersion:1.0 }\ncmd.checkRedeploy:153 success\nworkdir:/tmp/ones1336995671\ncmd.renderRedeployDockerfile:157 enter\ncmd.renderRedeployDockerfile:170 success\ncmd.buildRedeployImage:174 enter\nBuilding image ones-release:0.1.15420.sp-1.0.1\nBuilding image will take several minutes,Please wait a moment...\ncmd.buildRedeployImage:186 success\nPlease continue to execute the following command to deploy the new image:\n        docker images | grep 0.1.15420.sp-1.0.1\n        enter deployment path(cd /data/ones/...)\n        rm -rf *.sp-*.tar && touch 0.1.15420.sp-1.0.1.tar && sh upgrade.sh && rm -rf 0.1.15420.sp-1.0.1.tar\nTo rollback the deployment image, execute the following command:\n        enter deployment path(cd /data/ones/...)\n        view the port (config.json 'port'|'https_port' field)\n        docker ps | grep (port) //get CONTAINER ID\n        docker rm -f (CONTAINER ID)\n        view the volume name (config.json 'volume' field)\n        docker volume rm (volume name), may be wrong please check the documentation(https://developer.ones.com/) or contact us.\n        ./onesconfigure regain --p backup package(.tar)\nIf you encounter any problems, please check the documentation(https://developer.ones.com/) or contact us.\n===================================================================================================================\n")),(0,a.kt)("h5",{id:"deploy-a-new-image"},"Deploy a new image"),(0,a.kt)("p",null,"Divided into two categories: test environment deployment, production environment deployment. Both, the process is the same, but there are different requirements for the tag number."),(0,a.kt)("p",null,"Follow the prompts in step 2 to deploy the new image. First cd into the deployment path, and then use upgrade.sh to deploy the new image."),(0,a.kt)("p",null,"For Example\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"[root@auto-test ~]# docker images | grep 0.1.15420.sp-1.0.1\nones-release                     0.1.15420.sp-1.0.1            269507c43b62   5 minutes ago   11.6GB\n[root@auto-test ~]# cd /data/ones/pkg/69test_8fa28d\n[root@auto-test 69test_8fa28d]# ls\nones-test-0.1.14476  ones-test-0.1.14476.tar.gz\n[root@auto-test 69test_8fa28d]# cd ones-test-0.1.14476\n[root@auto-test ones-test-0.1.14476]# ls *.sh\nenv.sh  ones-deploy.sh  private_check.sh  upgrade.sh\n[root@auto-test ones-test-0.1.14476]# rm -rf *.sp-*.tar && touch 0.1.15420.sp-1.0.1.tar && sh upgrade.sh && rm -rf 0.1.15420.sp-1.0.1.tar\nCheck version\n Umask is 0022, is ok\nDisk space is ok\n1\n1\n1\n1\nLocal version: 0.1.15420  online version: 0.1.15420.sp-1.0.1\nNew version found, confirm upgrade: Y/N\ny\nStart upgrade...\n[INFO] 2022/10/11 12:07:50 image exists [ones-release:0.1.15420.sp-1.0.1]\n[INFO] 2022/10/11 12:07:54 get options from volume\n[INFO] 2022/10/11 12:07:55 upgrade options\n[INFO] 2022/10/11 12:07:55  check param enable_host_name_leak !!!!!!!!!!!\n[INFO] 2022/10/11 12:07:55  end check param enable_host_name_leak !!!!!!!!!!!\n[WARN] 2022/10/11 12:07:55 You are going to update from version 0.1.15420 to version 0.1.15420.sp-1.0.1 .\nIn version 3.6 you need to export audit log.\nHave you export the audit log?(enter Y/N)\nn\nAre you sure update ONES?(enter Y/N)\ny\n[INFO] 2022/10/11 12:07:57 stop openresty, ones-ai-audit-log-sync, ones-ai-binlog-event-sync, ones-ai-project-api, ones-ai-wiki-api...\n[INFO] 2022/10/11 12:07:58 backup audit-log-sync offset ...\n[INFO] 2022/10/11 12:07:58 Backup volume data\n[INFO] 2022/10/11 12:08:17 waiting for mysql up ...\n")),(0,a.kt)("h5",{id:"verify-the-result"},"Verify the result"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Front-end effect verification"),(0,a.kt)("li",{parentName:"ul"},"docker commands")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"docker ps |grep 443\n")),(0,a.kt)("h5",{id:"rollback-optional"},"Rollback ","[Optional]"),(0,a.kt)("p",null,"If you need to roll back to the previous environment, follow the prompts in step 2 or view the log content of /tmp/ones_open.log."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"1\u3001Go to the deployment package directory\n2\u3001View the deployment environment port number // cat config.json | grep port\n3\u3001implement docker ps | grep (port) //get CONTAINER ID\n4\u3001implement docker rm -f (CONTAINER ID) //delete container\n5\u3001View the deployment environment container volume name // cat config.json | grep volume\n6\u3001implement docker volume rm (volume name) //delete container volume This step may report an error, please see the operation example below\n7\u3001implement ./onesconfigure regain --p (backup package) // backup package:backup package in the deployment package directory  rollback operation\n")),(0,a.kt)("h3",{id:"high-availability-environment"},"High Availability Environment"),(0,a.kt)("h4",{id:"preparation-1"},"Preparation"),(0,a.kt)("p",null,"Before you start, do the following preparations:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"High-availability environment equipment: k8s operates the machine to achieve high-availability update deployment (such as 192.168.100.10)."),(0,a.kt)("li",{parentName:"ul"},"Front-end custom tar package: locally build & generate custom tar package, such as ones-wiki-web.tar.gz."),(0,a.kt)("li",{parentName:"ul"},"Operation and maintenance tools: docker , onesopenwiki.\nInstall and configure the ",(0,a.kt)("a",{parentName:"li",href:"https://www.docker.com/products/docker-desktop/"},"dokcer")," environment locally.")),(0,a.kt)("p",null,"Confirm permission. The onesopenwiki tool must have executable permission\u3002"),(0,a.kt)("h4",{id:"step-by-step-1"},"Step By Step"),(0,a.kt)("h5",{id:"execute-the-onesopenwiki-tool-to-generate-a-local-image"},"Execute the onesopenwiki tool to generate a local image"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"./onesopenwiki webimage --wiki_web_out_tag=xxx --wiki_web_tar=xxx\n")),(0,a.kt)("p",null,"\u2022 You can get help by executing the command ./onesopenwiki webimage --help."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"[root@auto-test zhangyuan]# ./onesopenwiki webimage --help\nBuild wiki_web image based on the customer Wiki Web tar package\n\nUsage:\n  onesopenwiki webimage [flags]\n\nFlags:\n      --wiki_web_out_tag string   [option]Tag of output ones-release image, format\uff1a${currentVersion}.sp-${ones_release_out_tag_major_version}.${number}\n      --wiki_web_tar string       [require]Tar package of ONES.AI Wiki Web\uff0csuffix:.tar.gz\n")),(0,a.kt)("p",null,"\u2022 wiki_web_tar parameter, required, suffix format: .tar.gz. This parameter specifies the front-end custom tar package."),(0,a.kt)("p",null,"You can refer to Private Deployment get wiki_web_tar param."),(0,a.kt)("p",null,"\u2022 wiki_web_out_tag parameter, optional. According to the front-end tar package, the tag of the mirror wiki-web is generated."),(0,a.kt)("p",null,"Users can customize the format requirements: 9.0.yyyymmddxx, all numbers, and cannot have the same name as the existing wiki-web mirror tag."),(0,a.kt)("p",null,"\u2022 Executing this command will generate a local image file, which can be viewed through docker images |grep xxx"),(0,a.kt)("p",null,"For Example\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"[root@auto-test zhangyuan]# ./onesopenwiki webimage --wiki_web_tar=ones-wiki-web.tar.gz\n===================================================================================================================\n2022-09-11 11:11:22\nlog: /tmp/ones_open_wiki.log\ncmd.checkWebImage:51 enter\ninput params:{WikiWebTar:ones-wiki-web.tar.gz WikiWebOutTag:}\nAuto generate params...\ngenerate params:{WikiWebTar:ones-wiki-web.tar.gz WikiWebOutTag:9.0.2022081100}\ncmd.checkWebImage:91  success\nworkdir:/tmp/ones685568270\ncmd.renderWebImageDockerfile:126 enter\ncmd.renderWebImageDockerfile:138 success\ncmd.buildWebImageImage:142 enter\nBuilding image wiki-web:9.0.2022081100\nBuilding image will take several minutes,Please wait a moment...\ncmd.buildWebImageImage:154 success\nShow the generated image:\n    docker images | grep 9.0.2022081100\n===================================================================================================================\n\n")),(0,a.kt)("h5",{id:"push-the-image-to-the-publicprivate-repository"},"Push the image to the public|private repository"),(0,a.kt)("p",null,'If the image is hosted in the public repository Dockerhub, then refer to "method a" to push to the public repository; if it is a customer\'s private repository, refer to "method b" to push to the private repository.'),(0,a.kt)("p",null,"\u2022 Push to public repository"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"docker tag wiki-web:9.0.2022080201 onestest/wiki-web:v9.0.0\ndocker push onestest/wiki-web:v9.0.0\n")),(0,a.kt)("p",null,"\u2022 Push to private repository"),(0,a.kt)("p",null,"Take the private repository 192.168.1.100 as an example:"),(0,a.kt)("p",null,"\u2022 Configure trusted private warehouse (optional)"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'#Note that if your private repository has a trusted https certificate, you do not need to modify /etc/docker/daemon.json\nvim /etc/docker/daemon.json\n{\n    "insecure-registers":[\n        "192.168.1.100"\n    ]\n}\n\nsystemctl restart docker\n')),(0,a.kt)("p",null,"\u2022 Login to private repository"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"#param u is the login user account; param p is the password of the user.\ndocker login 192.168.1.100 -u xxx -p xxx\n")),(0,a.kt)("p",null,"\u2022 Push to private repository"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"docker tag wiki-web:9.0.2022080201  192.168.1.100/project/wiki-web:v9.0.2\ndocker push 192.168.1.100/project/wiki-web:v9.0.2\n")),(0,a.kt)("p",null,"Login ",(0,a.kt)("a",{parentName:"p",href:"https://192.168.1.100/"},"repository")," \uff0cand view the image file just uploaded"),(0,a.kt)("h5",{id:"high-availability-deployment"},"High availability deployment"),(0,a.kt)("p",null,"Log in to the k8s operation machine and perform the following steps to implement the rolling update operation."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"#Configuration file priority description: config/private.yaml > config/public.yaml > default/config.yaml\n\n#Modify config/private.yaml. Add or modify wikiWebImage\n\n# wikiWebImage: 192.168.1.100/project/wiki-web:v9.0.2\nvi /data/ones/ones-ai-k8s/config/private.yaml\n# Redeploy the high availability environment\nmake setup-ones\n")),(0,a.kt)("h5",{id:"verify-the-result-1"},"Verify the result"),(0,a.kt)("p",null,"\u2022 Check the tag of the wiki-web image. Such as:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl -n ones-namespace  get pods -o yaml |grep image |grep wiki-web\n")),(0,a.kt)("p",null,"\u2022 Front-end effect verification"),(0,a.kt)("h5",{id:"rollback-optional-1"},"Rollback ","[Optional]"),(0,a.kt)("p",null,"If you need to roll back this deployment, you can do following commands."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"#Revert operation 3 changes back\nvi /data/ones/ones-ai-k8s/config/private.yaml\n\nmake setup-ones\n")),(0,a.kt)("h2",{id:"deploy-ones-project-web"},"Deploy ones-project-web"),(0,a.kt)("p",null,"You just need to replace ones-wiki-web.tar.gz with ones-ai-web.tar.gz\uff0cand change the operation and maintenance tool onesopenwiki to onesopenproject\u3002"),(0,a.kt)("p",null,"In the High Availability Environment, the configuration item wikiWebIm age is changed to projectWebImage."),(0,a.kt)("p",null,"Other processes is same as the above documents."))}c.isMDXComponent=!0}}]);