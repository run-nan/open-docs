# 自动合并canary内容
name: AutoMergeCanary
on:
  pull_request:
    branches:
      - main
    paths:
      - 'docs/**'
      - 'i18n/zh-CN/docusaurus-plugin-content-docs/current/**'
    types:
      - labeled
jobs:
  labelchecker:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Get pull request labels
        id: label
        run: |
            labels=$(gh api -H "Accept: application/vnd.github+json" /repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/labels | jq --compact-output '[.[].name]')
            echo "res=$labels" >> $GITHUB_OUTPUT
      - name: Check the label
        if: ${{ !contains(steps.label.outputs.res, 'canary') }}
        run: |
            only deal with canary label
            exit 1
  pathchecker:
    needs: labelchecker
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: MikeCxx/paths-filter-strict@v1.0.8
      id: filter
      with:
        filters: |
          canary:
            - 'docs/**'
            - 'i18n/zh-CN/docusaurus-plugin-content-docs/current/**'
    - name: Check if only the canary has been changed
      if: steps.filter.outputs.canary == 'false'
      run: |
          found the unnecessary files changes in the pull request
          exit 1
  mergepullrequest:
    needs: pathchecker
    runs-on: ubuntu-latest
    env:
      pr_number: ${{ format('{0}', github.event.pull_request.number) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull request title lint
        uses: seferov/pr-lint-action@v1.2.0
        with:
          title-regex: '^(build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test)(\([A-Z]+[\s\S]*\))?:\s[\s\S]+'
          title-regex-flags: 'm'
          error-message: 'pull request title shoud like this [build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test: ***] or [build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test(Opfetch): ***]'

      - name: Approval pull request
        uses: pwei1018/bcrs-ci-action@v1.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          pr-approval: true
          pr-message: "auto merge for canary"

      - name: Merge pull request
        id: automerge
        uses: pascalgn/automerge-action@v0.15.5
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          MERGE_LABELS: "canary"
          MERGE_METHOD: "squash"
          MERGE_COMMIT_MESSAGE: pull-request-title

      - name: Fail result
        if: steps.automerge.outputs.mergeResult != 'merged'
        run: |
          merge failed: ${{ steps.automerge.outputs.mergeResult }}
          exit 1
  deploy:
    needs: mergepullrequest
    uses: ./.github/workflows/common.yml
    secrets:
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}