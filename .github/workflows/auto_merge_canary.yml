name: Auto Merge Canary

on:
  pull_request:
    branches:
      - next

jobs:
  mergepullrequest:
    runs-on: ubuntu-latest
    env:
      pr_number: ${{ format('{0}', github.event.pull_request.number) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull request title lint
        uses: seferov/pr-lint-action@v1.2.0
        with:
          title-regex: '^(build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test)(\([A-Z]+[\s\S]*\))?:\s[\s\S]+'
          title-regex-flags: 'm'
          error-message: 'pull request title shoud like this [build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test: ***] or [build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test(Opfetch): ***]'

      - name: Merge pull request
        id: automerge
        uses: pascalgn/automerge-action@v0.15.6
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          MERGE_LABELS: "canary"
          MERGE_METHOD: "squash"
          MERGE_COMMIT_MESSAGE: pull-request-title

      - name: Fail result
        if: steps.automerge.outputs.mergeResult != 'merged'
        run: |
          merge failed: ${{ steps.automerge.outputs.mergeResult }}
          exit 1
