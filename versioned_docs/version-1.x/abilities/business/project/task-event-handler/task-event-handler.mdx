---
sidebar_position: 3
description: Perform pre-processing, validation, and post-notification of events when the system generates updates to issue fields.
---

import Image from '@theme/IdealImage'

# Intercept issue field modifications

## Requirements

| ONES     |
| :------- |
| v3.7.54+ |

## Overview

When you want to do some processing and validation when issue field change, you can use the TaskEventHandle ability to achieve the requirement. This ability can pre-process, verify and post-proces the event when the system generates a issue update event. When the plugin that uses this ability is installed, the issue update event will be pre-process by the plugin before processing, and the plugin can ignore, reject, and modify this event according to requirements; after the event processing is completed, The plugin will receive a notification, and some post-process can be done at this time.

**Applicable scene**

1. A certain field or state of a issue has restrictions when changing, for example, it is not allowed to change the title of a issue of a requirement type.
2. Post operations are performed after issue field changes are complete. For example, after updating the person in charge of the issue of the requirement type, send an email to the corresponding person.

### Scope of application {#scope}

- **Covered**

  Including changes in issue field, script-field, and status;

  Including the UI operation and the events generated by directly calling the interface;

- **Not covered**

  Operations that do not directly change attributes/states, such as commenting and uploading files, are not included;

  Changes in calculated field such as number of stops, intervals, etc. are not included;

  Changes triggered by post-actions are not included;

  Does not include the processing of man-hour (man-hour are a separate `item` type, and the corresponding similar abilitiy will be added in the follow-up ability);

  Does not include state changes triggered by functions that modify state abnormally;

### Trigger

- Issue details page for field or status modification
- Modify field field in batches
- Batch change issue type

### Performance

Using the issue processor ability configuration does not allow modification of the person in charge of the requirement, and an error is reported when modifying the person in charge of the requirement

<Image img={require('./images/task-event-handle0.png')} />

## Usage

When ONES enables the plugin that uses the TaskEventHandle ability, the execution flow of issue field and state change events is shown in the following figure:

<Image img={require('./images/task-event-handle1.png')} />

### Step 1: Add configuration

Use `npx op add ability` to add `task-event-handler` ability. After adding, the `backend/src/task-event-handler.ts` file will be added, and the following configurations will be added to the configuration file.

:::tip
Developers only need to pay attention to two configurations of **issue type** and **issue field**. Multiple configurations of **issue type** and **issue field** are supported. Between multiple configurations Delimited by **","** .
:::

Example configuration: Indicates **issue type** that focus on **requirement** and **defect** , **issue field** that focus on **Due date** and **assign** change event.

```yaml title="config/plugin.yaml"
abilities:
  - id: _ZcH89U9
    name: TaskEventHandler
    version: 1.0.0
    abilityType: TaskEventHandler
    function:
      taskPreActionFunc: taskPreAction
      taskActionDoneFunc: taskActionDone
    config:
      - key: issueTypeScope
        value: 'Requirement,Bug'
        fieldType: Input
        label: IssueType
        show: true
      - key: field
        value: 'Assignee,Due date,'
        fieldType: Input
        label: IssueField
        show: true
```

### Step 2: Add pre-processing

The `backend/src/task-event-handler.ts` file will automatically generate the `taskPreAction` function, which is a pre-processing function. This function will be called before the event takes effect, and different strategies will be adopted according to the returned contentã€‚

- **Return**

  The structure of the content returned by the `taskPreAction` function is as follows, and different strategies are adopted according to the values of the `is_follow`, `is_reject` and `task_events` fields:

  - Ignore: Set the returned `is_follow = false`, indicating that the plugin does not do additional processing, and the update event is executed according to the normal process.
  - Reject: Set the returned `is_follow = true && is_reject = true`, which means that the update event will not be executed and will end directly.
  - Accept: Set the returned `is_follow = true && is_reject = false`, which means accepting the event, but not modifying the update content, and only notifying the plugin after the event is completed.
  - Modification: Set the returned `is_follow = true && is_reject = false` and add field modification by returning the `task_events` object to indicate acceptance of this event, modify the update content this time and notify the plugin after the event is completed.

:::caution NOTICE
Even if there is no need to add new modifications in the plugin logic, the data in the original `task_events` field needs to be returned, otherwise the change event may fail
:::

```typescript
type taskPreResponse = {
  statusCode: number
  body: {
    code: number
    body: {
      is_follow: boolean
      is_reject: boolean
      reject_reason: string
      task_events: any
      other_data: string
    }
  }
}
```

| Param         | Type                      | Required | Description                                                          |
| :------------ | :------------------------ | :------- | :------------------------------------------------------------------- |
| is_follow     | string                    | Y        | Express concern                                                      |
| is_reject     | string                    | Y        | Whether to refuse                                                    |
| reject_reason | string                    | N        | Reject reason                                                        |
| task_events   | [[]TaskEvent](#TaskEvent) | Y        | Changed data (plugins can add changed field values)                  |
| other_data    | interface                 | N        | Other data (this data will be passed to the `taskActionDone` method) |

- **Params**

  Include the following content in the request body of the function input parameter:

  | Param       | Type                      | Required | Description           |
  | ----------- | ------------------------- | -------- | --------------------- |
  | user_uuid   | string                    | Y        | User's `uuid`         |
  | lang        | string                    | Y        | Current user language |
  | task_events | [[]TaskEvent](#TaskEvent) | Y        | Changed data          |

  #### TaskEvent {#TaskEvent}

  | Param                     | Type                                | Required | Description                                                                                                                                                                                 |
  | ------------------------- | ----------------------------------- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
  | task_fields               | [[]TaskEventField](#TaskEventField) | Y        | Change field list                                                                                                                                                                           |
  | task_uuid                 | string                              | Y        | The `uuid` of the issue                                                                                                                                                                     |
  | action                    | string                              | Y        | `update`: general field<br />`transit`: status change (with step field)<br />`change_issue_type`: issue type change<br />`publish_version`: version release<br />`add `: create a new issue |
  | issue_type_scope_uuid     | string                              | Y        | Issue type `UUID` under the project to which it belongs                                                                                                                                     |
  | issue_type_scope_name     | string                              | Y        | The name of the issue type under the project                                                                                                                                                |
  | issue_type_scope_name_map | map[string]string                   | Y        | The name of `issue_type_scope` in each language version                                                                                                                                     |

  #### TaskEventField {#TaskEventField}

  | Param            | Type              | Required | Description                                                                                                                             |
  | :--------------- | :---------------- | :------- | :-------------------------------------------------------------------------------------------------------------------------------------- |
  | field_uuid       | string            | N        | The `uuid` of the field                                                                                                                 |
  | field_type       | string            | N        | Field type                                                                                                                              |
  | field_name       | string            | N        | The `key` for the field name                                                                                                            |
  | field_name_map   | map[string]string | N        | The name of each language version of the field, such as: <br />en: 'Assignee/Owner' <br />origin: '{{field.assign}}' <br />zh: 'è´Ÿè´£äºº' |
  | field_value_type | string            | N        | Field value type:<br />0 - any<br />1 - int<br />2 - string<br />3 - []string                                                           |
  | value            | interface         | N        | Field value                                                                                                                             |

- **Example**

  After modifying the field or state of a issue, the title of the issue will be modified synchronously.

  ```typescript title="backend/src/task-event-handler.ts"
  export async function taskPreAction(request: PluginRequest): Promise<PluginResponse> {
    const body = request?.body as any
    const userUUID = body.user_uuid
    const lang = body.lang
    const events = body.task_events
    const action = events[0].action
    Logger.info('nEvents', events)
    Logger.info('userID:', userUUID)
    Logger.info('lang', lang)
    Logger.info('action', action)
    // Add field modification
    const aField = {
      field_name: 'Title',
      value: 'test title',
    }
    events[0].task_fields.push(aField)
    return {
      statusCode: 200,
      body: {
        code: 200,
        body: {
          is_follow: true,
          is_reject: false,
          reject_reason: '',
          task_events: events,
          other_data: 'other data',
        },
      },
    }
  }
  ```

- **Special note**ï¼šIf you want the page to pop a custom `warning toast`,you can set it in the following ways

```typescript title="backend/src/task-event-handler.ts"
export async function taskPreAction(request: PluginRequest): Promise<PluginResponse> {
  return {
    body: {
      code: 400,
      reason: 'Test warning error',
      type: 'warning',
      model: 'plugin.xxx',
    },
  }
}
```

<Image img={require('./images/task-event-handler2.png')} />

### Step 3: Add post-processing

The `taskActionDone` function is automatically generated in the `backend/src/task-event-handler.ts` file. This function is post-processing and will be called first after the event takes effect.

- Params

  | Param       | Type                      | Required | Description                                                      |
  | :---------- | :------------------------ | :------- | :--------------------------------------------------------------- |
  | user_uuid   | string                    | Y        | User `uuid`                                                      |
  | lang        | string                    | Y        | Current user language                                            |
  | task_events | [[]TaskEvent](#TaskEvent) | Y        | Changed data                                                     |
  | other_data  | interface                 | N        | Other data (this data will come from the `taskPreAction` method) |

- **Example**

  ```typescript title="backend/src/task-event-handler.ts"
  export async function taskActionDone(request: PluginRequest): Promise<PluginResponse> {
    var body = request?.body as any
    var events = body.task_events
    var otherData = body.other_data
    var userUUID = body.user_uuid
    var lang = body.lang
    var action = events[0].action
    Logger.info('ans event', events)
    Logger.info('ans other_data', otherData)
    Logger.info('ans userID:', userUUID)
    Logger.info('ans lang', lang)
    Logger.info('ans action', action)

    return {
      statusCode: 200,
      body: {
        code: 200,
      },
    }
  }
  ```

### NOTICE

1. When `TaskEvent.action` is `transit`, `publish_version`, the plugin is not allowed to modify the state.
2. The processing logic of `taskPreAction` is earlier than the required verification of the step field. If the plugin changes the value of the required item of the step field to an empty value, an error will be reported.
3. When `TaskEvent.action` is `change_issue_type`, the plugin is not allowed to modify the issue type and parent issue.
4. `TaskEvent` does not support the deletion of a field change.
